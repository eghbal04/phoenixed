<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Suppress MetaMask RPC errors that don't affect functionality - MUST be first -->
    <script>
      window.addEventListener('error', function(e){
        const m = (e && e.message) || '';
        if (m.includes('isDefaultWallet') || m.includes('getEnabledChains') || m.includes('Internal JSON-RPC error')) {
          e.preventDefault();
          return false;
        }
      });
      window.addEventListener('unhandledrejection', function(e){
        const r = e && e.reason;
        const msg = (r && (r.message || r)) || '';
        if (typeof msg === 'string' && (msg.includes('isDefaultWallet') || msg.includes('getEnabledChains') || msg.includes('Internal JSON-RPC error'))) {
          e.preventDefault();
          return false;
        }
      });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfer - IAM Platform</title>
    
    <!-- CSS Files - All styles are inline for better performance -->

    
    <style>
      :root{ --bg:#0b0f17; --card:#0f1420; --elev:#121a2a; --border:#22304a; --accent:#5da0ff; --accent2:#33d69f; --text:#e6eaf0; }
      body { background:var(--bg); min-height:100vh; margin:0; padding:16px; font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Arial; color:var(--text); }
      .container { max-width: 560px; margin: 0 auto; background: var(--card); border-radius: 14px; padding: 14px; border: 1px solid var(--border); box-shadow:0 8px 24px rgba(0,0,0,.25); }
      
      .header {
        text-align: center;
        margin-bottom: 0.8rem;
      }
      
      .header h1 {
        color: #00ff88;
        font-size: 1.8rem;
        margin: 0 0 0.2rem 0;
      }
      
      .back-btn {
        position: fixed;
        top: 1rem;
        left: 1rem;
        background: linear-gradient(135deg, #a786ff, #00ff88);
        color: #0a0f1c;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        font-size: 0.9rem;
      }
      
      .form-group {
        margin-bottom: 0.5rem;
      }
      
      .form-group label { display:block; color:#cfe3ff; margin-bottom:6px; font-weight:600; font-size:0.95rem; }
      
      .form-group input, .form-group select { width:100%; background:#0f1420; border:1px solid var(--border); color:var(--text); padding:12px; border-radius:12px; outline:none; font-size:1rem; box-sizing:border-box; }
      .form-group input:focus, .form-group select:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(93,160,255,.15); }
      
      .form-group input:focus, .form-group select:focus {
        border-color: #00ff88;
      }
      
      .search-row {
        display: flex;
        gap: 0.4rem;
        align-items: center;
      }
      
      .search-row input {
        flex: 1;
      }
      
      .search-row button { background:#1a2335; color:#cfe3ff; border:1px solid var(--border); padding:12px; border-radius:12px; font-weight:600; cursor:pointer; white-space:nowrap; font-size:.95rem; }
      
      .max-btn-input {
        background: rgba(0, 255, 136, 0.2) !important;
        color: #00ff88 !important;
        border: 1px solid rgba(0, 255, 136, 0.4) !important;
        font-weight: 700 !important;
        transition: all 0.3s ease;
      }
      
      .max-btn-input:hover {
        background: rgba(0, 255, 136, 0.3) !important;
        border-color: rgba(0, 255, 136, 0.6) !important;
        transform: translateY(-1px);
      }
      
      .max-btn-input:active {
        transform: translateY(0);
      }
      
      .balance-container {
        margin: 0.4rem 0;
        display: flex;
        justify-content: center;
      }
      
      .balance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.3rem;
        margin: 0.4rem 0;
      }
      
      .balance-card {
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.3);
        border-radius: 6px;
        padding: 0.4rem;
        text-align: center;
      }
      
      .balance-card h4 {
        color: #00ff88;
        margin: 0 0 0.1rem 0;
        font-size: 0.75rem;
      }
      
      .balance-card .amount {
        color: #ffffff;
        font-size: 0.75rem;
        font-weight: 600;
        font-family: monospace;
        word-break: break-all;
        line-height: 1.2;
      }
      
      .balance-card .usd-amount {
        color: #00ff88;
        font-size: 0.7rem;
        font-weight: 500;
        font-family: monospace;
        margin-top: 0.15rem;
      }
      
      .balance-card .usd-toggle-btn {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
        border: 1px solid rgba(0, 255, 136, 0.4);
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        font-size: 0.65rem;
        cursor: pointer;
        margin-top: 0.15rem;
        transition: all 0.3s ease;
      }
      
      .balance-card .usd-toggle-btn:hover {
        background: rgba(0, 255, 136, 0.3);
        border-color: rgba(0, 255, 136, 0.6);
      }
      
      .balance-amount-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin: 0.2rem 0;
      }
      
      .balance-amount-container .amount {
        flex: 1;
        text-align: left;
        margin: 0;
      }
      
      .max-btn {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
        border: 1px solid rgba(0, 255, 136, 0.4);
        border-radius: 4px;
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 40px;
      }
      
      .max-btn:hover {
        background: rgba(0, 255, 136, 0.3);
        border-color: rgba(0, 255, 136, 0.6);
        transform: translateY(-1px);
      }
      
      .max-btn:active {
        transform: translateY(0);
      }
      
      #transfer-usd-converter {
        background: rgba(0, 255, 136, 0.05);
        border: 1px solid rgba(0, 255, 136, 0.2);
        border-radius: 6px;
        padding: 0.5rem;
        margin-top: 0.3rem;
      }
      
      #transfer-usd-converter label {
        color: #00ff88;
        font-weight: 600;
        margin-bottom: 0.3rem;
        font-size: 0.85rem;
      }
      
      #usdConversionStatus {
        font-size: 0.8rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.3s ease;
        padding: 0.4rem;
      }
      
      .transfer-btn { width:100%; background:linear-gradient(135deg, #2f9950, #2b8a3e); color:#e6eaf0; border:1px solid #3aa654; border-radius:12px; padding:12px; font-weight:700; cursor:pointer; font-size:1.05rem; margin-top:8px; }
      
      .status {
        margin-top: 0.4rem;
        padding: 0.5rem;
        border-radius: 6px;
        text-align: center;
        font-weight: 500;
        font-size: 0.9rem;
      }
      
      .status.success {
        background: rgba(0, 255, 136, 0.1);
        color: #00ff88;
        border: 1px solid rgba(0, 255, 136, 0.3);
      }
      
      .status.error {
        background: rgba(255, 68, 68, 0.1);
        color: #ff4444;
        border: 1px solid rgba(255, 68, 68, 0.3);
      }
      
      .status.loading {
        background: rgba(167, 134, 255, 0.1);
        color: #a786ff;
        border: 1px solid rgba(167, 134, 255, 0.3);
      }
      
      #searchIndexStatus {
        font-size: 0.75rem;
        word-break: break-all;
        line-height: 1.3;
        font-family: monospace;
      }
      
      .wallet-status { background: rgba(93,160,255,.08); border:1px solid rgba(93,160,255,.25); border-radius:12px; padding:10px; margin-bottom:8px; text-align:center; font-size:.95rem; }
      

      
      @media (max-width: 768px) {
        .container {
          margin: 0.25rem;
          padding: 0.75rem;
        }
        
        .header h1 {
          font-size: 1.5rem;
        }
        
        .balance-container {
          margin: 0.3rem 0;
        }
        
        .balance-grid {
          grid-template-columns: 1fr;
          gap: 0.25rem;
        }
        
        .balance-card {
          padding: 0.3rem;
        }
        
        .balance-card h4 {
          font-size: 0.7rem;
        }
        
        .balance-card .amount {
          font-size: 0.7rem;
          word-break: break-all;
          line-height: 1.1;
        }
        
        .balance-card .usd-amount {
          font-size: 0.65rem;
        }
        
        .balance-card .usd-toggle-btn {
          font-size: 0.55rem;
          padding: 0.15rem 0.3rem;
        }
        
        .balance-amount-container {
          gap: 0.3rem;
          margin: 0.15rem 0;
        }
        
        .max-btn {
          font-size: 0.6rem;
          padding: 0.25rem 0.5rem;
          min-width: 35px;
        }
        
        #transfer-usd-converter {
          padding: 0.4rem;
          margin-top: 0.2rem;
        }
        
        #usdConversionStatus {
          font-size: 0.7rem;
          padding: 0.3rem;
        }
        
        #searchIndexStatus {
          font-size: 0.65rem;
          word-break: break-all;
          line-height: 1.2;
        }
      }
      
    </style>
</head>
<body>
    
    <!-- Back Button -->
    <a href="index.html" class="back-btn">‚Üê Back</a>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üí∏ Transfer</h1>
        </div>

        <!-- Wallet Status -->
        <div id="walletStatus" class="wallet-status" style="display: none;">
            <div>Wallet: <span id="addressDisplay">üîÑ Connecting...</span></div>
            <div id="connectionStatus" style="display:none;margin-top:0.5rem;">
                <div id="connectionMessage">‚ö†Ô∏è Connecting to wallet...</div>
            </div>
        </div>

        <!-- Transfer Form -->
        <form id="transferForm">
            <!-- Destination Address -->
            <div class="form-group">
                <label for="transferTo">Destination Address</label>
                <input type="text" id="transferTo" placeholder="0x..." required>
            </div>

            <!-- Index Search -->
            <div class="form-group">
                <label>üîç Search by Index</label>
                <div class="search-row">
                    <input type="number" id="searchIndex" placeholder="Enter user index">
                    <button type="button" id="searchIndexBtn">üîç Search</button>
                </div>
                <div id="searchIndexStatus" style="text-align:center;padding:0.5rem;margin-top:0.5rem;border-radius:6px;"></div>
            </div>

            <!-- Amount -->
            <div class="form-group">
                <label for="transferAmount">Amount</label>
                <div class="search-row">
                    <input type="number" id="transferAmount" placeholder="Enter amount" min="0" step="any" required>
                    <button type="button" id="maxAmountBtnInput" class="max-btn-input">Max</button>
                </div>
            </div>

            <!-- USD Converter (for IAM token) -->
            <div id="transfer-usd-converter" class="form-group" style="display: none;">
                <label for="transferUsdAmount">üí≤ USD Amount</label>
                <div class="search-row">
                    <input type="number" id="transferUsdAmount" placeholder="Enter USD amount" min="0" step="0.01">
                    <button type="button" id="convertUsdToTokenBtn">üîÑ Convert</button>
                </div>
                <div id="usdConversionStatus" style="text-align:center;padding:0.5rem;margin-top:0.5rem;border-radius:6px;"></div>
            </div>

            <!-- Token Type -->
            <div class="form-group">
                <label for="transferToken">Token Type</label>
                <select id="transferToken" required>
                    <option value="DAI">üü¢ DAI</option>
                    <option value="POL">üîµ POL (MATIC)</option>
                    <option value="IAM">üü£ IAM</option>
                </select>
            </div>

            <!-- Selected Token Balance -->
            <div id="selected-token-balance" class="balance-container" style="display: none;">
                <div class="balance-card" id="selected-balance-card">
                    <h4 id="selected-token-name">üü¢ DAI</h4>
                    <div class="balance-amount-container">
                        <div id="selected-token-amount" class="amount">-</div>
                        <button type="button" id="maxAmountBtn" class="max-btn">Max</button>
                    </div>
                    <div id="selected-token-usd" class="usd-amount" style="display: none;">-</div>
                    <button id="selected-token-usd-toggle" class="usd-toggle-btn" style="display: none;">üí≤ USD</button>
                </div>
            </div>

            <!-- Transfer Button -->
            <button type="submit" class="transfer-btn">üì§ Execute Transfer</button>
        </form>

        <!-- Status Message -->
        <div id="transferStatus" class="status"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/transfer-form.js"></script>

    
    <!-- Contract Configuration -->
    <script>
        // Contract Configuration - Updated to new contract
        window.IAM_ADDRESS = '0xa4C37107AbaeD664978e5f6db79249Ad08Fe0dBf';
        
        // Use the full ABI from config.js instead of limited ABI
        // The full ABI will be loaded from config.js
        console.log('üîÑ Transfer page: Setting contract address to:', window.IAM_ADDRESS);
        
        // Ensure ABI is loaded from config.js
        if (window.IAM_ABI) {
            console.log('‚úÖ ABI loaded from config.js');
        } else {
            console.log('‚ö†Ô∏è ABI not loaded, waiting for config.js...');
            // Wait for config.js to load
            setTimeout(() => {
                if (window.IAM_ABI) {
                    console.log('‚úÖ ABI loaded after delay');
                } else {
                    console.error('‚ùå ABI still not available');
                }
            }, 1000);
        }
        
        // Force contract connection with new address
        window.ensureContractConnection = async function() {
            console.log('üîó Ensuring contract connection...');
            console.log('Contract Address:', window.IAM_ADDRESS);
            console.log('ABI Available:', !!window.IAM_ABI);
            console.log('Config Available:', !!window.contractConfig);
            
            if (window.contractConfig && window.contractConfig.contract) {
                console.log('‚úÖ Contract already connected');
                return window.contractConfig.contract;
            }
            
            if (window.ethereum && window.IAM_ADDRESS && window.IAM_ABI) {
                try {
                    // Use ethers.js v5 syntax for compatibility
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();
                    const contract = new ethers.Contract(window.IAM_ADDRESS, window.IAM_ABI, signer);
                    
                    console.log('‚úÖ Contract connected successfully');
                    return contract;
                } catch (error) {
                    console.error('‚ùå Contract connection failed:', error);
                    return null;
                }
            } else {
                console.error('‚ùå Missing requirements for contract connection');
                return null;
            }
        };
        
        // Auto-connect to new contract on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Transfer page loaded, ensuring new contract connection');
            
            // Force contract update
            if (typeof window.forceContractUpdate === 'function') {
                window.forceContractUpdate();
            }
            
            // Ensure contract connection
            setTimeout(() => {
                window.ensureContractConnection();
            }, 1000);
        });
    </script>
    
    <script>

        
        // Update wallet display
        function updateWalletButton() {
            const addressDisplay = document.getElementById('addressDisplay');
            const connectionStatus = document.getElementById('connectionStatus');
            const connectionMessage = document.getElementById('connectionMessage');
            
            if (window.transferManager && window.transferManager.signer) {
                if (addressDisplay) {
                    window.transferManager.signer.getAddress().then(address => {
                        const shortAddress = address.substring(0, 6) + '...' + address.substring(address.length - 4);
                        addressDisplay.textContent = 'üü¢ ' + shortAddress;
                    }).catch(() => {
                        addressDisplay.textContent = 'üü¢ Connected';
                    });
                }
                
                if (connectionStatus && connectionMessage) {
                    connectionStatus.style.display = 'block';
                    connectionStatus.style.background = 'rgba(0, 255, 136, 0.1)';
                    connectionStatus.style.border = '1px solid rgba(0, 255, 136, 0.3)';
                    connectionStatus.style.color = '#00ff88';
                    connectionMessage.textContent = '‚úÖ Connected!';
                }
            } else {
                if (addressDisplay) {
                    addressDisplay.textContent = 'üîÑ Connecting...';
                }
                
                if (connectionStatus && connectionMessage) {
                    connectionStatus.style.display = 'block';
                    connectionStatus.style.background = 'rgba(255, 193, 7, 0.1)';
                    connectionStatus.style.border = '1px solid rgba(255, 193, 7, 0.3)';
                    connectionStatus.style.color = '#ffc107';
                    connectionMessage.textContent = '‚ö†Ô∏è Connecting...';
                }
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            if (typeof ethers === 'undefined') {
                console.error('Ethers.js not loaded');
                return;
            }
            
            let attempts = 0;
            while (attempts < 50) {
                if (typeof window.TransferManager !== 'undefined') {
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (typeof window.TransferManager === 'undefined') {
                console.error('TransferManager not found');
                return;
            }
            
            try {
                window.transferManager = new window.TransferManager();
                await window.transferManager.initializeTransfer();
                updateWalletButton();
                setupSearchFunctionality();
            } catch (error) {
                console.error('Error initializing TransferManager:', error);
            }
        });
        
        // Setup search functionality
        function setupSearchFunctionality() {
            const searchIndexBtn = document.getElementById('searchIndexBtn');
            const searchIndexInput = document.getElementById('searchIndex');
            const searchIndexStatus = document.getElementById('searchIndexStatus');
            const transferToInput = document.getElementById('transferTo');
            
            if (!searchIndexBtn || !searchIndexInput || !searchIndexStatus || !transferToInput) {
                return;
            }
            
            searchIndexBtn.addEventListener('click', performIndexSearch);
            searchIndexInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performIndexSearch();
                }
            });
            
            async function performIndexSearch() {
                const index = searchIndexInput.value.trim();
                
                if (!index || isNaN(index) || parseInt(index) < 1) {
                    showSearchStatus('Please enter a valid index (number > 0)', 'error');
                    return;
                }
                
                try {
                    showSearchStatus('üîç Searching for user...', 'loading');
                    searchIndexBtn.disabled = true;
                    searchIndexBtn.textContent = 'üîÑ Searching...';
                    
                    console.log('üîç Starting search for index:', index);
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Search timeout after 15 seconds')), 15000)
                    );
                    
                    const searchPromise = convertIndexToAddress(parseInt(index));
                    const address = await Promise.race([searchPromise, timeoutPromise]);
                    
                    console.log('üéØ Search result:', address);
                    
                    if (address && address !== '0x0000000000000000000000000000000000000000') {
                        transferToInput.value = address;
                        showSearchStatus(`‚úÖ Found: ${address}`, 'success');
                    } else {
                        showSearchStatus('‚ùå User not found for this index', 'error');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Search error:', error);
                    let errorMessage = '‚ùå Search failed';
                    
                    if (error.message.includes('timeout')) {
                        errorMessage = '‚è∞ Search timeout - try again';
                    } else if (error.message.includes('MetaMask')) {
                        errorMessage = 'ü¶ä MetaMask connection issue';
                    } else if (error.message.includes('Contract')) {
                        errorMessage = 'üìã Contract call failed';
                    } else if (error.message.includes('User not found')) {
                        errorMessage = 'üë§ User not found for this index';
                    }
                    
                    showSearchStatus(errorMessage, 'error');
                } finally {
                    searchIndexBtn.disabled = false;
                    searchIndexBtn.textContent = 'üîç Search';
                }
            }
            
            function showSearchStatus(message, type) {
                searchIndexStatus.textContent = message;
                searchIndexStatus.className = `search-status ${type}`;
                
                switch (type) {
                    case 'success':
                        searchIndexStatus.style.background = 'rgba(0, 255, 136, 0.1)';
                        searchIndexStatus.style.color = '#00ff88';
                        searchIndexStatus.style.border = '1px solid rgba(0, 255, 136, 0.3)';
                        break;
                    case 'error':
                        searchIndexStatus.style.background = 'rgba(255, 68, 68, 0.1)';
                        searchIndexStatus.style.color = '#ff4444';
                        searchIndexStatus.style.border = '1px solid rgba(255, 68, 68, 0.3)';
                        break;
                    case 'loading':
                        searchIndexStatus.style.background = 'rgba(255, 165, 0, 0.1)';
                        searchIndexStatus.style.color = '#ffa500';
                        searchIndexStatus.style.border = '1px solid rgba(255, 165, 0, 0.3)';
                        break;
                }
            }
        }
        
        // Convert index to address
        async function convertIndexToAddress(index) {
            try {
                // Prefer using the already-connected TransferManager resolver
                if (window.transferManager && typeof window.transferManager.resolveDestinationAddress === 'function') {
                    const addr = await window.transferManager.resolveDestinationAddress(String(index));
                    return addr;
                }
                // Fallback: ensure wallet connection and basic provider, then call indexToAddress if present
                if (!window.ethereum) throw new Error('MetaMask not installed');
                let accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (!accounts || accounts.length === 0) throw new Error('Please connect your wallet first');
                const provider = (typeof ethers.providers !== 'undefined' && ethers.providers.Web3Provider)
                    ? new ethers.providers.Web3Provider(window.ethereum)
                    : new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const abi = window.IAM_ABI || [];
                const contract = new ethers.Contract(window.IAM_ADDRESS, abi, signer);
                // New contract: getAddressByNumber(uint256)
                if (typeof contract.getAddressByNumber === 'function') {
                    const addr = await contract.getAddressByNumber(parseInt(index, 10));
                    return addr;
                }
                // Legacy fallback
                if (typeof contract.indexToAddress === 'function') {
                    const addr = await contract.indexToAddress(parseInt(index, 10));
                    return addr;
                }
                throw new Error('Address resolver not available in ABI');
            } catch (error) {
                console.error('‚ùå Error in convertIndexToAddress:', error);
                throw error;
            }
        }
    </script>
    
</body>
</html>
