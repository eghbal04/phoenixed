<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Tool - Binary Tree Structure</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0f1c, #1a1f2e);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(26, 31, 46, 0.8);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(167, 134, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #a786ff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(167, 134, 255, 0.5);
        }

        .header p {
            color: #9ecbff;
            font-size: 1.1rem;
        }

        .status-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .status-card.error {
            background: rgba(255, 68, 68, 0.1);
            border-color: rgba(255, 68, 68, 0.3);
        }

        .status-card.warning {
            background: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .contract-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .contract-card {
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid rgba(167, 134, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
        }

        .contract-card h3 {
            color: #a786ff;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .contract-address {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            color: #9ecbff;
        }

        .migration-controls {
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid rgba(167, 134, 255, 0.2);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .migration-controls h3 {
            color: #a786ff;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .btn {
            background: linear-gradient(135deg, #a786ff, #00ff88);
            color: #0a0f1c;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(167, 134, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.danger {
            background: linear-gradient(135deg, #ff4444, #cc3333);
            color: #ffffff;
        }

        .btn.warning {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: #0a0f1c;
        }

        .progress-section {
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid rgba(167, 134, 255, 0.2);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #a786ff, #00ff88);
            width: 0%;
            transition: width 0.3s ease;
        }

        .log-section {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(167, 134, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(167, 134, 255, 0.1);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry.success {
            color: #00ff88;
        }

        .log-entry.error {
            color: #ff4444;
        }

        .log-entry.warning {
            color: #ffc107;
        }

        .log-entry.info {
            color: #9ecbff;
        }

        .migration-stats {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(167, 134, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(26, 31, 46, 0.6);
            border-radius: 6px;
            border: 1px solid rgba(167, 134, 255, 0.1);
        }

        .stat-label {
            color: #9ecbff;
            font-size: 0.9rem;
        }

        .stat-value {
            color: #a786ff;
            font-weight: 600;
            font-size: 1rem;
        }

        .stat-value.success {
            color: #00ff88;
        }

        .stat-value.error {
            color: #ff4444;
        }

        .comparison-table-section {
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid rgba(167, 134, 255, 0.2);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 10px 8px;
            text-align: center;
            border: 1px solid rgba(167, 134, 255, 0.2);
        }

        .comparison-table th {
            background: rgba(167, 134, 255, 0.1);
            color: #a786ff;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .comparison-table td {
            color: #9ecbff;
        }

        .comparison-table tr:nth-child(even) {
            background: rgba(167, 134, 255, 0.05);
        }

        .status-success {
            color: #00ff88;
            font-weight: 600;
        }

        .status-error {
            color: #ff4444;
            font-weight: 600;
        }

        .status-pending {
            color: #ffc107;
            font-weight: 600;
        }

        .address-cell {
            font-family: monospace;
            font-size: 0.8rem;
            word-break: break-all;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: rgba(26, 31, 46, 0.6);
            border: 1px solid rgba(167, 134, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
        }

        .info-card h4 {
            color: #a786ff;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .info-value {
            color: #9ecbff;
            font-size: 0.9rem;
            word-break: break-all;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .contract-info {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ Migration Tool</h1>
            <p>Ø§Ù†ØªÙ‚Ø§Ù„ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®Øª Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø§Ø² Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù‚Ø¯ÛŒÙ… Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯</p>
        </div>

        <div id="statusCard" class="status-card">
            <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</h3>
            <p id="statusText">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„...</p>
        </div>

        <div class="contract-info">
            <div class="contract-card">
                <h3>ğŸ“œ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù‚Ø¯ÛŒÙ…</h3>
                <div class="contract-address" id="oldContractAddress">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            </div>
            <div class="contract-card">
                <h3>ğŸ†• Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
                <div class="contract-address" id="newContractAddress">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
            </div>
        </div>

        <div class="user-info" id="userInfo" style="display: none;">
            <div class="info-card">
                <h4>ğŸ‘¤ Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„</h4>
                <div class="info-value" id="userAddress">-</div>
            </div>
            <div class="info-card">
                <h4>ğŸŒ³ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ø¯Ø±Ø®Øª</h4>
                <div class="info-value" id="userPosition">-</div>
            </div>
            <div class="info-card">
                <h4>ğŸ‘¥ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§</h4>
                <div class="info-value" id="userChildren">-</div>
            </div>
            <div class="info-card">
                <h4>ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ IAM</h4>
                <div class="info-value" id="userBalance">-</div>
            </div>
        </div>

        <div class="migration-controls">
            <h3>ğŸ”„ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†</h3>
            <button id="exportSnapshotBtn" class="btn">ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ JSON Ø´Ø¨Ú©Ù‡</button>
            <input id="importSnapshotInput" type="file" accept="application/json" style="display:none" />
            <button id="importSnapshotBtn" class="btn">ğŸ“¥ ÙˆØ±ÙˆØ¯ JSON Ø´Ø¨Ú©Ù‡</button>
            <button id="analyzeBtn" class="btn">ğŸ” ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®Øª</button>
            <button id="migrateBtn" class="btn danger" disabled>ğŸš€ Ø´Ø±ÙˆØ¹ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„</button>
            <button id="verifyBtn" class="btn warning" disabled>âœ… ØªØ£ÛŒÛŒØ¯ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„</button>
            <button id="resumeBtn" class="btn" disabled style="display: none;">ğŸ”„ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†</button>
            <button id="skipErrorBtn" class="btn warning" disabled style="display: none;">â­ï¸ Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø®Ø·Ø§ Ùˆ Ø§Ø¯Ø§Ù…Ù‡</button>
        </div>

        <div class="progress-section" id="progressSection" style="display: none;">
            <h3>ğŸ“ˆ Ù¾ÛŒØ´Ø±ÙØª Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0% - Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹</p>
            
            <div class="migration-stats" id="migrationStats" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</span>
                        <span class="stat-value" id="totalUsersCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ø´Ø¯Ù‡:</span>
                        <span class="stat-value success" id="migratedUsersCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Ù†Ø§Ù…ÙˆÙÙ‚:</span>
                        <span class="stat-value error" id="failedUsersCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´:</span>
                        <span class="stat-value" id="processingUsersCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="comparison-table-section" id="comparisonTableSection" style="display: none;">
            <h3>ğŸ“Š Ø¬Ø¯ÙˆÙ„ ØªØ·Ø¨ÛŒÙ‚ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
            <div class="table-container">
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù‚Ø¯ÛŒÙ…</th>
                            <th>Ø¢Ø¯Ø±Ø³ Ù‚Ø¯ÛŒÙ…</th>
                            <th>Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯</th>
                            <th>Ø±ÙØ±Ø± Ù‚Ø¯ÛŒÙ…</th>
                            <th>Ø±ÙØ±Ø± Ø¬Ø¯ÛŒØ¯</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        </tr>
                    </thead>
                    <tbody id="comparisonTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="log-section">
            <h3>ğŸ“ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„ÛŒØ§Øª</h3>
            <div id="logContainer">
                <div class="log-entry info">Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª...</div>
            </div>
        </div>
    </div>

    <!-- Load config.js first -->
    <script src="js/config.js"></script>
    <script>
        class MigrationManager {
            constructor() {
                this.oldContract = null;
                this.newContract = null;
                this.signer = null;
                this.userAddress = null;
                this.treeStructure = null;
                this.isMigrating = false;
                this.migrationQueue = [];
                this.migratedUsers = new Set();
                this.failedUsers = new Set();
                this.totalUsers = 0;
                this.processedUsers = 0;
                this.visitedUsers = new Set();
                
                this.initialize();
            }

            async initialize() {
                try {
                    this.log('ğŸ”„ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§ØªØµØ§Ù„...', 'info');
                    
                    // Add a small delay to ensure MetaMask is ready
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    await this.connectWallet();
                    await this.setupContracts();
                    await this.loadUserData();
                    this.updateStatus('âœ… Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'success');
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ: ${error.message}`, 'error');
                    this.updateStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…', 'error');
                    
                    // Add retry button
                    this.addRetryButton();
                }
            }

            addRetryButton() {
                const statusCard = document.getElementById('statusCard');
                const retryBtn = document.createElement('button');
                retryBtn.textContent = 'ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯';
                retryBtn.className = 'btn';
                retryBtn.style.marginTop = '10px';
                retryBtn.onclick = () => {
                    retryBtn.remove();
                    this.initialize();
                };
                statusCard.appendChild(retryBtn);
            }

            async connectWallet() {
                try {
                    // Check if MetaMask is available
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('MetaMask ÛŒØ§ÙØª Ù†Ø´Ø¯ - Ù„Ø·ÙØ§Ù‹ MetaMask Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯');
                    }

                    // Check if MetaMask is locked
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (!accounts || accounts.length === 0) {
                            // Request account access
                            const newAccounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                            if (!newAccounts || newAccounts.length === 0) {
                                throw new Error('Ù‡ÛŒÚ† Ø­Ø³Ø§Ø¨ Ú©ÛŒÙ Ù¾ÙˆÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ - Ù„Ø·ÙØ§Ù‹ MetaMask Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Ø­Ø³Ø§Ø¨ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                            }
                            this.userAddress = newAccounts[0];
                        } else {
                            this.userAddress = accounts[0];
                        }
                    } catch (requestError) {
                        if (requestError.code === 4001) {
                            throw new Error('Ú©Ø§Ø±Ø¨Ø± Ø§ØªØµØ§Ù„ Ø±Ø§ Ø±Ø¯ Ú©Ø±Ø¯ - Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯');
                        } else if (requestError.code === -32002) {
                            throw new Error('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø³Øª - Ù„Ø·ÙØ§Ù‹ MetaMask Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯');
                        } else {
                            throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„: ${requestError.message}`);
                        }
                    }

                    this.log(`âœ… Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯: ${this.userAddress.substring(0, 6)}...${this.userAddress.substring(38)}`, 'success');
                } catch (error) {
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„: ${error.message}`);
                }
            }

            async setupContracts() {
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    this.signer = await provider.getSigner();

                    // Wait for config to be loaded
                    if (!window.DEFAULT_IAM_ADDRESS || !window.SECOND_IAM_ADDRESS) {
                        this.log('â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯...', 'info');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }

                    // Get contract addresses from config
                    const oldAddress = window.DEFAULT_IAM_ADDRESS;
                    const newAddress = window.SECOND_IAM_ADDRESS;

                    if (!oldAddress || !newAddress) {
                        throw new Error('Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¯Ø± ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯ - Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯');
                    }

                    // Update UI
                    document.getElementById('oldContractAddress').textContent = oldAddress;
                    document.getElementById('newContractAddress').textContent = newAddress;

                    // Create contract instances
                    this.oldContract = new ethers.Contract(oldAddress, window.IAM_ABI, this.signer);
                    this.newContract = new ethers.Contract(newAddress, window.IAM_ABI, this.signer);

                    this.log('âœ… Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯', 'success');
                } catch (error) {
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯Ù‡Ø§: ${error.message}`);
                }
            }

            async loadUserData() {
                try {
                    // Get user position in old contract
                    const userData = await this.oldContract.users(this.userAddress);
                    const userTree = await this.oldContract.getUserTree(this.userAddress);
                    
                    // Update UI
                    document.getElementById('userAddress').textContent = this.userAddress;
                    document.getElementById('userPosition').textContent = `Ø´Ø§Ø®Ù‡ ${userData.index.toString()}`;
                    document.getElementById('userChildren').textContent = `Ú†Ù¾: ${userTree.left}, Ø±Ø§Ø³Øª: ${userTree.right}`;
                    
                    const balance = await this.oldContract.balanceOf(this.userAddress);
                    const balanceFormatted = ethers.formatUnits(balance, 18);
                    document.getElementById('userBalance').textContent = `${parseFloat(balanceFormatted).toFixed(6)} IAM`;

                    document.getElementById('userInfo').style.display = 'grid';
                    this.log('âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', 'success');
                } catch (error) {
                    this.log(`âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±: ${error.message}`, 'warning');
                }
            }

            async analyzeTreeStructure() {
                try {
                    this.log('ğŸ” Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ù…Ù„ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®Øª...', 'info');
                    
                    // Get total users count for reference (but don't use as limit)
                    this.totalUsers = await this.oldContract.wallets();
                    this.log(`ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† (Ù…Ø±Ø¬Ø¹): ${this.totalUsers.toString()}`, 'info');

                    // If a snapshot is loaded, use it; otherwise build by DFS
                    if (this.snapshot && Array.isArray(this.snapshot) && this.snapshot.length) {
                        this.log('ğŸ§© Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø³Ù†Ù¾â€ŒØ´Ø§Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ù†Ù‚Ø´Ù‡ Ú˜Ù†ÙˆÙ„ÙˆÚ˜ÛŒ', 'info');
                        await this.loadSnapshotIntoState(this.snapshot);
                    } else {
                        this.log('ğŸŒ³ Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ DFS...', 'info');
                        await this.buildCompleteGenealogy();
                    }
                    
                    this.log('âœ… ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®Øª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯', 'success');
                    document.getElementById('migrateBtn').disabled = false;
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø±: ${error.message}`, 'error');
                }
            }

            async exportSnapshot() {
                try {
                    // Ensure genealogy is built
                    if (!this.userIndexMap || this.userIndexMap.size === 0) {
                        this.log('â„¹ï¸ Ø§Ø¨ØªØ¯Ø§ ØªØ­Ù„ÛŒÙ„ Ø¯Ø±Ø®Øª Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø§Ø³Ù†Ù¾â€ŒØ´Ø§Øª Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯', 'info');
                        return;
                    }
                    const sortedIndices = Array.from(this.userIndexMap.keys()).sort((a,b)=>a-b);
                    const snapshot = [];
                    for (const idx of sortedIndices) {
                        const address = this.userIndexMap.get(idx);
                        const data = this.genealogyMap.get(address) || {};
                        snapshot.push({
                            index: idx,
                            address,
                            referrer: data.referrer || '0x0000000000000000000000000000000000000000'
                        });
                    }
                    const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `iam-network-snapshot-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                    this.log('ğŸ“¤ Ø§Ø³Ù†Ù¾â€ŒØ´Ø§Øª JSON Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØµØ§Ø¯Ø± Ø´Ø¯', 'success');
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ JSON: ${error.message}`, 'error');
                }
            }

            async importSnapshot(file) {
                try {
                    const text = await file.text();
                    const json = JSON.parse(text);
                    if (!Array.isArray(json)) throw new Error('ÙØ±Ù…Øª JSON Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
                    this.snapshot = json;
                    await this.loadSnapshotIntoState(json);
                    this.log('ğŸ“¥ Ø§Ø³Ù†Ù¾â€ŒØ´Ø§Øª JSON Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯', 'success');
                    document.getElementById('migrateBtn').disabled = false;
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ JSON: ${error.message}`, 'error');
                }
            }

            async loadSnapshotIntoState(snapshotArray) {
                // Reset maps
                this.genealogyMap = new Map();
                this.userIndexMap = new Map();
                this.comparisonData = [];
                this.visitedUsers = new Set();
                for (const item of snapshotArray) {
                    if (!item || !item.index || !item.address) continue;
                    this.userIndexMap.set(Number(item.index), item.address);
                    this.genealogyMap.set(item.address, {
                        index: String(item.index),
                        referrer: item.referrer || '0x0000000000000000000000000000000000000000',
                        upper: item.referrer || '0x0000000000000000000000000000000000000000',
                        left: '0x0000000000000000000000000000000000000000',
                        right: '0x0000000000000000000000000000000000000000'
                    });
                    this.comparisonData.push({
                        oldIndex: Number(item.index),
                        oldAddress: item.address,
                        newAddress: null,
                        oldReferrer: item.referrer || '0x0000000000000000000000000000000000000000',
                        newReferrer: null,
                        status: 'pending'
                    });
                }
                this.updateComparisonTable();
            }

            async buildCompleteGenealogy() {
                try {
                    this.genealogyMap = new Map();
                    this.userIndexMap = new Map();
                    this.comparisonData = [];
                    this.visitedUsers = new Set();
                    
                    this.log(`ğŸ” Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬ÙˆÛŒ DFS Ø¯Ø±Ø®Øª Ø¨Ø§ÛŒÙ†Ø±ÛŒ...`, 'info');
                    this.log(`ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: ${this.totalUsers}`, 'info');
                    
                    // Start DFS from root user (index 1)
                    await this.dfsTraversal(1);
                    
                    // Check if we found all users from wallets variable
                    if (this.genealogyMap.size < this.totalUsers) {
                        this.log(`âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: ÙÙ‚Ø· ${this.genealogyMap.size} Ú©Ø§Ø±Ø¨Ø± Ø§Ø² ${this.totalUsers} Ú©Ø§Ø±Ø¨Ø± wallets ÛŒØ§ÙØª Ø´Ø¯`, 'warning');
                    } else if (this.genealogyMap.size > this.totalUsers) {
                        this.log(`â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: ${this.genealogyMap.size} Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ø´Ø¯ (Ø¨ÛŒØ´ØªØ± Ø§Ø² ${this.totalUsers} wallets)`, 'info');
                    }
                    
                    this.log(`âœ… Ø¬Ø³ØªØ¬ÙˆÛŒ DFS Ù¾Ø§ÛŒØ§Ù† ÛŒØ§ÙØª: ${this.genealogyMap.size} Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ø´Ø¯`, 'success');
                    this.updateComparisonTable();
                } catch (error) {
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ù†Ù‚Ø´Ù‡ Ú˜Ù†ÙˆÙ„ÙˆÚ˜ÛŒ: ${error.message}`);
                }
            }

            async dfsTraversal(index) {
                try {
                    // Skip if already visited or invalid index
                    if (this.visitedUsers.has(index) || index <= 0) {
                        return;
                    }

                    // Get user address by index
                    const userAddress = await this.oldContract.indexToAddress(index);
                    
                    // Skip if address is empty
                    if (userAddress === '0x0000000000000000000000000000000000000000') {
                        return;
                    }

                    // Mark as visited
                    this.visitedUsers.add(index);

                    // Get referrer using getReferrer function with index
                    const referrerAddress = await this.oldContract.getReferrer(index);
                    
                    // Get user data (addresses left/right are not used for traversal)
                    const userData = await this.oldContract.users(userAddress);
                    
                    // Store user data
                    this.genealogyMap.set(userAddress, {
                        index: userData.index.toString(),
                        referrer: referrerAddress,
                        upper: referrerAddress, // Use referrer as upper
                        left: '0x0000000000000000000000000000000000000000',
                        right: '0x0000000000000000000000000000000000000000',
                        binaryPoints: userData.binaryPoints ? userData.binaryPoints.toString() : '0',
                        depositedAmount: userData.depositedAmount ? userData.depositedAmount.toString() : '0',
                        lastMonthlyClaim: userData.lastMonthlyClaim ? userData.lastMonthlyClaim.toString() : '0',
                        totalMonthlyRewarded: userData.totalMonthlyRewarded ? userData.totalMonthlyRewarded.toString() : '0',
                        refclimed: userData.refclimed ? userData.refclimed.toString() : '0'
                    });
                    
                    this.userIndexMap.set(index, userAddress);
                    
                    // Add to comparison data
                    this.comparisonData.push({
                        oldIndex: index,
                        oldAddress: userAddress,
                        newAddress: null,
                        oldReferrer: referrerAddress,
                        newReferrer: null,
                        status: 'pending'
                    });
                    
                    this.log(`âœ… Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index} ÛŒØ§ÙØª Ø´Ø¯: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`, 'success');
                    
                    // Recursively visit children by index with left-first priority
                    const leftIndex = await this.oldContract.getLeftChild(index);
                    const leftAddress = await this.oldContract.indexToAddress(Number(leftIndex));
                    if (leftAddress !== '0x0000000000000000000000000000000000000000') {
                        await this.dfsTraversal(Number(leftIndex));

                        // Only check right child if left exists (per register logic)
                        const rightIndex = await this.oldContract.getRightChild(index);
                        const rightAddress = await this.oldContract.indexToAddress(Number(rightIndex));
                        if (rightAddress !== '0x0000000000000000000000000000000000000000') {
                            await this.dfsTraversal(Number(rightIndex));
                        }
                    }
                    
                } catch (error) {
                    this.log(`âš ï¸ Ø®Ø·Ø§ Ø¯Ø± DFS Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ ${index}: ${error.message}`, 'warning');
                }
            }

            async startMigration() {
                if (this.isMigrating) return;
                
                this.isMigrating = true;
                document.getElementById('migrateBtn').disabled = true;
                document.getElementById('progressSection').style.display = 'block';
                document.getElementById('migrationStats').style.display = 'block';
                document.getElementById('comparisonTableSection').style.display = 'block';
                
                try {
                    this.log('ğŸš€ Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„...', 'info');
                    
                    // Build migration queue in correct order (by index)
                    await this.buildMigrationQueue();
                    
                    this.log(`ğŸ“‹ ØµÙ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: ${this.migrationQueue.length} Ú©Ø§Ø±Ø¨Ø± (Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø§ÛŒÙ†Ø¯Ú©Ø³)`, 'info');
                    
                    // Update statistics and table
                    this.updateMigrationStats();
                    this.updateComparisonTable();
                    
                    // Process migration queue
                    await this.processMigrationQueue();
                    
                    this.log('âœ… Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯', 'success');
                    document.getElementById('verifyBtn').disabled = false;
                    // Hide skip error button when migration completes successfully
                    document.getElementById('skipErrorBtn').style.display = 'none';
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†: ${error.message}`, 'error');
                    this.log(`âš ï¸ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ù…ØªÙˆÙ‚Ù Ø´Ø¯ØŒ Ø§Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ "Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†" ÛŒØ§ "Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø®Ø·Ø§" Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯`, 'warning');
                    document.getElementById('resumeBtn').style.display = 'inline-block';
                    document.getElementById('resumeBtn').disabled = false;
                    document.getElementById('skipErrorBtn').style.display = 'inline-block';
                    document.getElementById('skipErrorBtn').disabled = false;
                } finally {
                    this.isMigrating = false;
                    // Keep resume button enabled even after errors
                    document.getElementById('resumeBtn').disabled = false;
                }
            }

            async buildMigrationQueue() {
                try {
                    this.migrationQueue = [];
                    
                    // Build migration queue using all found users (sorted by index)
                    const sortedIndices = Array.from(this.userIndexMap.keys()).sort((a, b) => a - b);
                    
                    for (const index of sortedIndices) {
                        const userAddress = this.userIndexMap.get(index);
                        if (userAddress) {
                            this.migrationQueue.push({
                                index: index,
                                address: userAddress,
                                referrer: this.genealogyMap.get(userAddress).referrer
                            });
                        }
                    }
                    
                    this.log(`ğŸ“‹ ØµÙ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: ${this.migrationQueue.length} Ú©Ø§Ø±Ø¨Ø± (Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ø§ÛŒÙ†Ø¯Ú©Ø³)`, 'info');
                } catch (error) {
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª ØµÙ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†: ${error.message}`);
                }
            }

            async processMigrationQueue() {
                try {
                    this.processedUsers = 0;
                    
                    for (const userInfo of this.migrationQueue) {
                        try {
                            const result = await this.migrateUser(userInfo);
                            this.migratedUsers.add(userInfo.address);
                            this.processedUsers++;
                            
                            // Update comparison data
                            this.updateComparisonData(userInfo.index, userInfo.address, result.newAddress, result.newReferrer, 'success');
                            
                            const progress = Math.round((this.processedUsers / this.migrationQueue.length) * 100);
                            this.updateProgress(progress, `Ø¯Ø± Ø­Ø§Ù„ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ø±Ø¨Ø± ${this.processedUsers} Ø§Ø² ${this.migrationQueue.length} (Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index})`);
                            
                            // Update statistics and table
                            this.updateMigrationStats();
                            this.updateComparisonTable();
                            
                            this.log(`âœ… Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} (${userInfo.address.substring(0, 6)}...${userInfo.address.substring(38)}) Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ø´Ø¯`, 'success');
                            
                            // Add small delay to avoid overwhelming the network
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                        } catch (error) {
                            this.failedUsers.add(userInfo.address);
                            
                            // Update comparison data with error
                            this.updateComparisonData(userInfo.index, userInfo.address, null, null, 'error');
                            
                            this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} (${userInfo.address.substring(0, 6)}...${userInfo.address.substring(38)}): ${error.message}`, 'error');
                            
                            // Update statistics and table even on failure
                            this.updateMigrationStats();
                            this.updateComparisonTable();
                            
                            // Continue migration instead of stopping - log error and move to next user
                            this.log(`âš ï¸ Ø±Ø¯ Ø´Ø¯Ù† Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} Ùˆ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†...`, 'warning');
                            
                            // Add small delay before continuing
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    this.updateProgress(100, 'Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„ Ø´Ø¯');
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØµÙ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†: ${error.message}`, 'error');
                    this.log(`âš ï¸ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ù…ØªÙˆÙ‚Ù Ø´Ø¯ØŒ Ø§Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ "Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†" Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯`, 'warning');
                }
            }

            async migrateUser(userInfo) {
                try {
                    const userAddress = userInfo.address;
                    const referrerAddress = userInfo.referrer;
                    
                    // Check if user already exists in new contract
                    const existingUser = await this.newContract.users(userAddress);
                    if (existingUser.index.toString() !== '0') {
                        this.log(`âš ï¸ Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} (${userAddress.substring(0, 6)}...${userAddress.substring(38)}) Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯`, 'warning');
                        
                        // Get new contract data for comparison
                        const newUserData = await this.newContract.users(userAddress);
                        const newUserTree = await this.newContract.getUserTree(userAddress);
                        
                        return {
                            newAddress: userAddress,
                            newReferrer: newUserTree.referrer
                        };
                    }
                    
                    // Register user in new contract using referrer as upper
                    if (referrerAddress !== '0x0000000000000000000000000000000000000000') {
                        // Pre-check with callStatic to capture revert reasons without spending gas
                        try {
                            await this.newContract.callStatic.registerAndActivate(
                                referrerAddress,
                                referrerAddress,
                                userAddress
                            );
                        } catch (preErr) {
                            const msg = (preErr && preErr.message) ? preErr.message : String(preErr);
                            if (msg.toLowerCase().includes('insufficient token balance')) {
                                this.log(`âŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª: Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªÙˆÚ©Ù† Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ. Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯/Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ ØªØ§Ù…ÛŒÙ† Ù…Ø§Ù„ÛŒ Ø´ÙˆØ¯ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ú¯Ø±Ø¯Ø¯.`, 'error');
                            } else {
                                this.log(`âŒ Ù¾ÛŒØ´â€ŒØ¨Ø±Ø±Ø³ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index}: ${msg}`, 'error');
                            }
                            throw new Error(msg);
                        }

                        // Send tx with manual gasLimit to bypass estimation errors (after successful callStatic)
                        const tx = await this.newContract.registerAndActivate(
                            referrerAddress, // referrer
                            referrerAddress, // upper (same as referrer)
                            userAddress,     // new user
                            { gasLimit: 1000000 }
                        );
                        await tx.wait();
                        
                        // Get new contract data after registration
                        const newUserData = await this.newContract.users(userAddress);
                        const newUserTree = await this.newContract.getUserTree(userAddress);
                        
                        this.log(`âœ… Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} (${userAddress.substring(0, 6)}...${userAddress.substring(38)}) Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯`, 'success');
                        
                        return {
                            newAddress: userAddress,
                            newReferrer: newUserTree.referrer
                        };
                    } else {
                        throw new Error(`Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} Ø±ÙØ±Ø± Ù†Ø¯Ø§Ø±Ø¯ - Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯`);
                    }
                    
                } catch (error) {
                    throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index}: ${error.message}`);
                }
            }

            async verifyMigration() {
                try {
                    this.log('ğŸ” Ø´Ø±ÙˆØ¹ ØªØ£ÛŒÛŒØ¯ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„...', 'info');
                    
                    let successCount = 0;
                    let failCount = 0;
                    
                    for (const userAddress of this.migrationQueue) {
                        try {
                            const newUserData = await this.newContract.users(userAddress);
                            if (newUserData.index.toString() !== '0') {
                                successCount++;
                            } else {
                                failCount++;
                                this.log(`âŒ Ú©Ø§Ø±Ø¨Ø± ${userAddress.substring(0, 6)}...${userAddress.substring(38)} Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯`, 'error');
                            }
                        } catch (error) {
                            failCount++;
                            this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± ${userAddress.substring(0, 6)}...${userAddress.substring(38)}: ${error.message}`, 'error');
                        }
                    }
                    
                    this.log(`ğŸ“Š Ù†ØªØ§ÛŒØ¬ ØªØ£ÛŒÛŒØ¯: ${successCount} Ù…ÙˆÙÙ‚ØŒ ${failCount} Ù†Ø§Ù…ÙˆÙÙ‚`, 'info');
                    
                    if (failCount === 0) {
                        this.log('âœ… Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯', 'success');
                    } else {
                        this.log(`âš ï¸ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ù†Ø§Ù‚Øµ: ${failCount} Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…ÙˆÙÙ‚`, 'warning');
                    }
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†: ${error.message}`, 'error');
                }
            }

            updateMigrationStats() {
                document.getElementById('totalUsersCount').textContent = this.migrationQueue.length;
                document.getElementById('migratedUsersCount').textContent = this.migratedUsers.size;
                document.getElementById('failedUsersCount').textContent = this.failedUsers.size;
                document.getElementById('processingUsersCount').textContent = this.processedUsers;
            }

            updateComparisonData(oldIndex, oldAddress, newAddress, newReferrer, status) {
                const data = this.comparisonData.find(item => item.oldIndex === oldIndex);
                if (data) {
                    data.newAddress = newAddress;
                    data.newReferrer = newReferrer;
                    data.status = status;
                }
            }

            updateComparisonTable() {
                const tbody = document.getElementById('comparisonTableBody');
                tbody.innerHTML = '';
                
                this.comparisonData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Old Index
                    const oldIndexCell = document.createElement('td');
                    oldIndexCell.textContent = item.oldIndex;
                    row.appendChild(oldIndexCell);
                    
                    // Old Address
                    const oldAddressCell = document.createElement('td');
                    oldAddressCell.className = 'address-cell';
                    oldAddressCell.textContent = item.oldAddress ? `${item.oldAddress.substring(0, 6)}...${item.oldAddress.substring(38)}` : '-';
                    row.appendChild(oldAddressCell);
                    
                    // New Address
                    const newAddressCell = document.createElement('td');
                    newAddressCell.className = 'address-cell';
                    newAddressCell.textContent = item.newAddress ? `${item.newAddress.substring(0, 6)}...${item.newAddress.substring(38)}` : '-';
                    row.appendChild(newAddressCell);
                    
                    // Old Referrer
                    const oldReferrerCell = document.createElement('td');
                    oldReferrerCell.className = 'address-cell';
                    oldReferrerCell.textContent = item.oldReferrer && item.oldReferrer !== '0x0000000000000000000000000000000000000000' 
                        ? `${item.oldReferrer.substring(0, 6)}...${item.oldReferrer.substring(38)}` : '-';
                    row.appendChild(oldReferrerCell);
                    
                    // New Referrer
                    const newReferrerCell = document.createElement('td');
                    newReferrerCell.className = 'address-cell';
                    newReferrerCell.textContent = item.newReferrer && item.newReferrer !== '0x0000000000000000000000000000000000000000' 
                        ? `${item.newReferrer.substring(0, 6)}...${item.newReferrer.substring(38)}` : '-';
                    row.appendChild(newReferrerCell);
                    
                    // Status
                    const statusCell = document.createElement('td');
                    statusCell.className = `status-${item.status}`;
                    switch(item.status) {
                        case 'success':
                            statusCell.textContent = 'âœ… Ù…ÙˆÙÙ‚';
                            break;
                        case 'error':
                            statusCell.textContent = 'âŒ Ø®Ø·Ø§';
                            break;
                        case 'pending':
                            statusCell.textContent = 'â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                            break;
                        default:
                            statusCell.textContent = item.status;
                    }
                    row.appendChild(statusCell);
                    
                    tbody.appendChild(row);
                });
            }

            async resumeMigration() {
                if (this.isMigrating) return;
                
                this.isMigrating = true;
                document.getElementById('resumeBtn').disabled = true;
                document.getElementById('migrateBtn').disabled = true;
                
                try {
                    this.log('ğŸ”„ Ø§Ø¯Ø§Ù…Ù‡ ÙØ±Ø¢ÛŒÙ†Ø¯ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†...', 'info');
                    
                    // Continue from where we left off
                    const remainingUsers = this.migrationQueue.filter(userInfo => 
                        !this.migratedUsers.has(userInfo.address) && !this.failedUsers.has(userInfo.address)
                    );
                    
                    this.log(`ğŸ“‹ ${remainingUsers.length} Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†`, 'info');
                    
                    // Process remaining users
                    for (const userInfo of remainingUsers) {
                        try {
                            const result = await this.migrateUser(userInfo);
                            this.migratedUsers.add(userInfo.address);
                            this.processedUsers++;
                            
                            // Update comparison data
                            this.updateComparisonData(userInfo.index, userInfo.address, result.newAddress, result.newReferrer, 'success');
                            
                            const progress = Math.round((this.processedUsers / this.migrationQueue.length) * 100);
                            this.updateProgress(progress, `Ø¯Ø± Ø­Ø§Ù„ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ø±Ø¨Ø± ${this.processedUsers} Ø§Ø² ${this.migrationQueue.length} (Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index})`);
                            
                            this.updateMigrationStats();
                            this.updateComparisonTable();
                            
                            this.log(`âœ… Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} (${userInfo.address.substring(0, 6)}...${userInfo.address.substring(38)}) Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ø´Ø¯`, 'success');
                            
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            
                        } catch (error) {
                            this.failedUsers.add(userInfo.address);
                            
                            // Update comparison data with error
                            this.updateComparisonData(userInfo.index, userInfo.address, null, null, 'error');
                            
                            this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} (${userInfo.address.substring(0, 6)}...${userInfo.address.substring(38)}): ${error.message}`, 'error');
                            
                            this.updateMigrationStats();
                            this.updateComparisonTable();
                            
                            // Continue migration instead of stopping - log error and move to next user
                            this.log(`âš ï¸ Ø±Ø¯ Ø´Ø¯Ù† Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒÙ†Ø¯Ú©Ø³ ${userInfo.index} Ùˆ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†...`, 'warning');
                            
                            // Add small delay before continuing
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    this.updateProgress(100, 'Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„ Ø´Ø¯');
                    this.log('âœ… Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ú©Ø§Ù…Ù„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯', 'success');
                    document.getElementById('verifyBtn').disabled = false;
                    // Hide skip error button when migration completes successfully
                    document.getElementById('skipErrorBtn').style.display = 'none';
                    
                } catch (error) {
                    this.log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†: ${error.message}`, 'error');
                    this.log(`âš ï¸ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù† Ù…ØªÙˆÙ‚Ù Ø´Ø¯ØŒ Ø§Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ "Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†" ÛŒØ§ "Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø®Ø·Ø§" Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯`, 'warning');
                    document.getElementById('skipErrorBtn').style.display = 'inline-block';
                    document.getElementById('skipErrorBtn').disabled = false;
                } finally {
                    this.isMigrating = false;
                    // Keep resume button enabled even after errors
                    document.getElementById('resumeBtn').disabled = false;
                }
            }

            async skipErrorAndContinue() {
                if (this.isMigrating) return;
                
                this.log('â­ï¸ Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø®Ø·Ø§ Ùˆ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒÚ¯Ø±ÛŒØ´Ù†...', 'info');
                
                // Simply call resumeMigration which now continues on errors
                await this.resumeMigration();
            }

            updateProgress(percentage, text) {
                document.getElementById('progressFill').style.width = `${percentage}%`;
                document.getElementById('progressText').textContent = `${percentage}% - ${text}`;
            }

            updateStatus(message, type) {
                const statusCard = document.getElementById('statusCard');
                const statusText = document.getElementById('statusText');
                
                statusCard.className = `status-card ${type}`;
                statusText.textContent = message;
            }

            log(message, type = 'info') {
                const logContainer = document.getElementById('logContainer');
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.migrationManager = new MigrationManager();
            
            // Setup event listeners
            document.getElementById('exportSnapshotBtn').addEventListener('click', () => {
                window.migrationManager.exportSnapshot();
            });

            document.getElementById('importSnapshotBtn').addEventListener('click', () => {
                document.getElementById('importSnapshotInput').click();
            });

            document.getElementById('importSnapshotInput').addEventListener('change', (e) => {
                const file = e.target.files && e.target.files[0];
                if (file) {
                    window.migrationManager.importSnapshot(file);
                    // reset input to allow same-file re-upload later if needed
                    e.target.value = '';
                }
            });
            document.getElementById('analyzeBtn').addEventListener('click', () => {
                window.migrationManager.analyzeTreeStructure();
            });
            
            document.getElementById('migrateBtn').addEventListener('click', () => {
                window.migrationManager.startMigration();
            });
            
            document.getElementById('verifyBtn').addEventListener('click', () => {
                window.migrationManager.verifyMigration();
            });
            
            document.getElementById('resumeBtn').addEventListener('click', () => {
                window.migrationManager.resumeMigration();
            });
            
            document.getElementById('skipErrorBtn').addEventListener('click', () => {
                window.migrationManager.skipErrorAndContinue();
            });
        });
    </script>
</body>
</html>

