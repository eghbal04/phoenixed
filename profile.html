<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <script>
    // Suppress noisy MetaMask RPC warnings
    window.addEventListener('error', function(e){
      const m = (e && e.message) || '';
      if (m.includes('getEnabledChains') || m.includes('isDefaultWallet') || m.includes('Could not establish connection') || m.includes('Internal JSON-RPC error')) { e.preventDefault(); return false; }
    });
    window.addEventListener('unhandledrejection', function(e){
      const r = e && e.reason; const msg = (r && (r.message || r)) || '';
      if (typeof msg === 'string' && (msg.includes('getEnabledChains') || msg.includes('isDefaultWallet') || msg.includes('Could not establish connection') || msg.includes('Internal JSON-RPC error'))) { e.preventDefault(); return false; }
    });
  </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <!-- Removed missing assets to avoid 404s -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        :root{ --bg:#0b0f17; --card:#0f1420; --elev:#121a2a; --border:#22304a; --accent:#5da0ff; --accent2:#33d69f; --text:#e6eaf0; --muted:#aab6d3; }
        body {
            font-family: 'Inter', 'SF Pro Display', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            direction: ltr;
            color: var(--text);
        }
        .container {
            max-width: 560px;
            margin: 16px auto;
            background: var(--card);
            border-radius: 14px;
            box-shadow: 0 8px 24px rgba(0,0,0,.25);
            padding: 16px;
            border: 1px solid var(--border);
        }
        
        /* Responsive Design for different screen sizes */
        @media (max-width: 768px) {
            .back-btn {
                top: 0.5rem;
                left: 0.5rem;
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .container { max-width: 96%; margin: 8px auto; padding: 12px; }
            h1 {
                font-size: 1.35em;
                margin-bottom: 8px;
            }
            .balance-box {
                flex-direction: column;
                gap: 8px;
                margin: 8px 0 12px 0;
                padding: 10px 8px 6px 8px;
            }
            .balance-item {
                flex: none;
                min-width: auto;
                margin: 0;
            }
            .balance-label {
                font-size: 0.85em;
            }
            .balance-value {
                font-size: 0.9em;
            }
            .profile-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
                padding: 6px 0;
                font-size: 0.9em;
            }
            .profile-value {
                word-break: break-all;
                font-size: 0.85em;
            }
        }
        
        @media (max-width: 480px) {
            .back-btn {
                top: 0.25rem;
                left: 0.25rem;
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .container {
                max-width: 99%;
                margin: 5px auto;
                padding: 12px 8px 8px 8px;
            }
            h1 {
                font-size: 1.3em;
                margin-bottom: 8px;
            }
            .balance-box {
                padding: 8px 6px 4px 6px;
                margin: 6px 0 8px 0;
                gap: 6px;
            }
            .balance-label {
                font-size: 0.8em;
            }
            .balance-value {
                font-size: 0.85em;
            }
            .profile-row { font-size: 0.9em; padding: 6px 8px; gap: 6px; }
            .profile-value {
                font-size: 0.8em;
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 80%;
                padding: 32px 28px 24px 28px;
            }
            .balance-box {
                gap: 20px;
            }
        }
        
        @media (min-width: 1025px) {
            .container {
                max-width: 700px;
                padding: 40px 32px 32px 32px;
            }
            .balance-box {
                gap: 24px;
            }
            .balance-item {
                flex: 1 1 140px;
                min-width: 140px;
            }
        }
        h1 { text-align:center; color:#cfe3ff; margin-bottom:16px; font-weight:700; letter-spacing:.3px; font-size:1.7em; }
        .profile-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; margin:4px 0; border-bottom:1px dashed #2a3550; font-size:0.95em; }
        .profile-row:hover{ background:rgba(93,160,255,.05); }
        .profile-row:last-child { border-bottom: none; }
        .profile-label { color:#c9d6ff; font-weight:600; letter-spacing:.2px; }
        .profile-value { color:#e6eaf0; font-family: monospace; }
        .balance-box { background: rgba(93,160,255,.08); border:1px solid rgba(93,160,255,.25); border-radius:12px; margin:12px 0 16px 0; padding:12px; display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; }
        .balance-item {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0));
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 10px 12px;
            text-align: center;
            box-shadow: 0 4px 14px rgba(167,134,255,0.08);
            transition: border-color .2s, box-shadow .2s, transform .2s;
        }
        .balance-item:hover { border-color:#a786ff33; box-shadow:0 8px 20px rgba(167,134,255,0.12); transform: translateY(-1px); }
        .balance-label { color: #00ff88; font-weight: bold; font-size: 0.9em; }
        .balance-value { color: #fff; font-size: 1em; font-family: monospace; margin-top: 2px; display: block; }
        
        .back-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: linear-gradient(135deg, #a786ff, #00ff88);
            color: #181c2a;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(167, 134, 255, 0.3);
        }

        .loading, .error-message {
            text-align: center;
            margin: 24px 0;
            color: #a786ff;
        }
        .error-message { color: #ff4444; }
        #copyProfileReferral:hover {
            background: linear-gradient(90deg,#a786ff,#00ff88) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,255,136,0.3);
        }
        #copyProfileReferral:active {
            transform: translateY(0);
        }
        
        /* Responsive withdrawal buttons */
        @media (max-width: 768px) {
            .withdrawal-buttons {
                flex-direction: column !important;
                gap: 0.6rem !important;
                margin-bottom: 1rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.6em 1.2em !important;
                font-size: 0.9em !important;
            }
            
            /* Responsive upgrade cap modal buttons */
            #upgrade-cap-modal div[style*="display:flex"] {
                flex-direction: column !important;
                gap: 0.6rem !important;
            }
            #upgrade-cap-modal button {
                padding: 0.6em 1.2em !important;
                font-size: 0.9em !important;
            }
        }
        
        @media (max-width: 480px) {
            .withdrawal-buttons {
                gap: 0.4rem !important;
                margin-bottom: 0.8rem !important;
            }
            .withdrawal-buttons button {
                padding: 0.5em 1em !important;
                font-size: 0.8em !important;
            }
            
            /* Responsive upgrade cap modal buttons for small screens */
            #upgrade-cap-modal div[style*="display:flex"] {
                gap: 0.4rem !important;
            }
            #upgrade-cap-modal button {
                padding: 0.5em 1em !important;
                font-size: 0.8em !important;
            }
        }
        
    </style>
</head>
<body>
    
    <!-- Back Button -->
    <a href="index.html" class="back-btn">‚Üê Back</a>
    
    <div class="container">
        <h1>User Profile</h1>
        <div id="profile-content">
            <div class="loading">Loading information...</div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/profile.js"></script>
    <script>
    // Disable/hide floating token card on profile page
    (function(){
      const hideFloatingCard = () => {
        try {
          const el = document.getElementById('floating-token-growth-card');
          if (el) el.remove();
          if (window.floatingTokenGrowthCard && typeof window.floatingTokenGrowthCard.destroy === 'function') {
            window.floatingTokenGrowthCard.destroy();
            window.floatingTokenGrowthCard = null;
          }
        } catch(_) {}
      };
      // Try immediately and with a few delays in case it appears later
      hideFloatingCard();
      document.addEventListener('DOMContentLoaded', hideFloatingCard);
      window.addEventListener('load', () => {
        hideFloatingCard();
        setTimeout(hideFloatingCard, 300);
        setTimeout(hideFloatingCard, 1500);
      });
      // Fallback: observe DOM for unexpected insertions
      try {
        const obs = new MutationObserver(hideFloatingCard);
        obs.observe(document.documentElement, {childList:true, subtree:true});
        setTimeout(()=>obs.disconnect(), 4000);
      } catch(_) {}
    })();
    </script>
    <script>
    function formatDateTime(ts) {
        if (!ts || ts == 0) return '-';
        // Convert to string and then number to avoid BigInt error
        let n = Number(ts.toString());
        if (isNaN(n)) return '-';
        // If the value is in seconds (small), multiply by 1000
        if (n < 10000000000) n = n * 1000;
        const d = new Date(n);
        if (isNaN(d.getTime())) return '-';
        // YYYY-MM-DD HH:mm
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0') + ' ' + String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
    }
    
    // Function to initialize withdrawal timers
    function startWithdrawalTimers(user) {
        const claimTimer = document.getElementById('claim-timer');
        const upgradeTimer = document.getElementById('upgrade-timer');
        
        if (!claimTimer) return;
        
        // Commission withdrawal timer (every 12 hours)
        function updateClaimTimer() {
            const now = Math.floor(Date.now() / 1000);
            const lastClaim = user.lastClaimTime ? Number(user.lastClaimTime) : 0;
            const nextClaimTime = lastClaim + (12 * 3600); // 12 hours
            const timeLeft = nextClaimTime - now;
            
            if (timeLeft > 0) {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                claimTimer.textContent = `‚è∞ ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                claimTimer.style.color = '#ff4444';
                claimTimer.style.fontWeight = 'bold';
            } else {
                claimTimer.textContent = '‚úÖ Ready';
                claimTimer.style.color = '#00ff88';
                claimTimer.style.fontWeight = 'bold';
            }
        }
        
        
        // Upgrade cap timer (every 15 days)
        function updateUpgradeTimer() {
            if (!upgradeTimer) return;
            
            const now = Math.floor(Date.now() / 1000);
            const lastUpgrade = user.upgradeTime ? Number(user.upgradeTime) : 0;
            const nextUpgradeTime = lastUpgrade + (15 * 24 * 3600); // 15 days
            const timeLeft = nextUpgradeTime - now;
            
            const upgradeBtn = document.getElementById('upgrade-cap-btn');
            
            if (timeLeft > 0) {
                const days = Math.floor(timeLeft / (24 * 3600));
                const hours = Math.floor((timeLeft % (24 * 3600)) / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                
                if (days > 0) {
                    upgradeTimer.textContent = `‚è∞ ${days}d ${hours}h`;
                } else if (hours > 0) {
                    upgradeTimer.textContent = `‚è∞ ${hours}h ${minutes}m`;
                } else {
                    upgradeTimer.textContent = `‚è∞ ${minutes}m`;
                }
                upgradeTimer.style.color = '#ff4444';
                upgradeTimer.style.fontWeight = 'bold';
                
                // Disable upgrade button when timer is active
                if (upgradeBtn) {
                    upgradeBtn.disabled = true;
                    upgradeBtn.style.opacity = '0.5';
                    upgradeBtn.style.cursor = 'not-allowed';
                    upgradeBtn.title = 'Upgrade cap is on cooldown. Please wait for timer to reach zero.';
                }
            } else {
                upgradeTimer.textContent = '‚úÖ Ready';
                upgradeTimer.style.color = '#00ff88';
                upgradeTimer.style.fontWeight = 'bold';
                
                // Enable upgrade button when timer reaches zero
                if (upgradeBtn) {
                    upgradeBtn.disabled = false;
                    upgradeBtn.style.opacity = '1';
                    upgradeBtn.style.cursor = 'pointer';
                    upgradeBtn.title = 'Upgrade binary points cap using IAM tokens. The more you upgrade, the higher your points cap becomes.';
                }
            }
        }
        
        // Initialize timers
        updateClaimTimer();
        updateUpgradeTimer();
        
        // Update every second
        setInterval(updateClaimTimer, 1000);
        setInterval(updateUpgradeTimer, 1000);
    }
    
    // Setup purchase point button functionality
    function setupPurchasePointButton(user, contract, address) {
        const purchasePointBtn = document.getElementById('purchase-point-btn');
        const statusDiv = document.getElementById('upgrade-cap-status');
        
        if (!purchasePointBtn || !statusDiv) return;
        
        purchasePointBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            // Disable button and show loading
            purchasePointBtn.disabled = true;
            purchasePointBtn.style.opacity = '0.5';
            purchasePointBtn.style.cursor = 'not-allowed';
            statusDiv.innerHTML = '‚è≥ Calculating required IAM for upgrade...';
            statusDiv.style.color = '#a786ff';
            
            try {
                // Check if user is registered  
                if (!(user.num && BigInt(user.num) > 0n)) {
                    throw new Error('You must be registered to purchase points');
                }
                
                // Get token price
                let tokenPrice = 0;
                try {
                    if (typeof contract.getTokenPrice === 'function') {
                        const tokenPriceRaw = await contract.getTokenPrice();
                        tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                    }
                } catch (e) {
                    console.log('Error getting token price:', e);
                }

                // Compute required IAM based on cap*3 and current totalPurchasedKind
                const cap = Number(user.binaryPointCap || 0);
                const effectiveCap = cap === 0 ? 1 : cap;
                const totalPurchased = Number(ethers.formatUnits((user.totalPurchasedKind || 0).toString(), 18));
                const requiredDai = effectiveCap * 3;
                const requiredIAM = tokenPrice > 0 ? (requiredDai / tokenPrice) : 0;
                const remainingIAM = requiredIAM > totalPurchased ? (requiredIAM - totalPurchased) : 0;
                const finalCostIAM = remainingIAM > 0 ? remainingIAM : requiredIAM;
                
                // Calculate USD equivalent
                const usdEquivalent = finalCostIAM * tokenPrice;
                
                // Show message box with token amount and USD equivalent
                statusDiv.innerHTML = `
                    <div style="background:rgba(0,255,136,0.1);border:2px solid #00ff88;border-radius:10px;padding:1rem;margin:0.5rem 0;text-align:center;">
                        <div style="color:#00ff88;font-weight:bold;font-size:1.1em;margin-bottom:0.5rem;">üéØ Purchase Toward Next Point</div>
                        <div style="color:#fff;font-size:1em;margin-bottom:0.3rem;">Token Amount: <span style="color:#a786ff;font-weight:bold;">${finalCostIAM.toFixed(6)} IAM</span></div>
                        <div style="color:#fff;font-size:1em;">USD Equivalent: <span style="color:#00ff88;font-weight:bold;">$${usdEquivalent.toFixed(4)}</span></div>
                        <div style="color:#ccc;font-size:0.9em;margin-top:0.5rem;">Payout: 100% to Contract ‚Ä¢ Max 1 point per 15 days by contract</div>
                    </div>
                `;
                statusDiv.style.color = '#00ff88';
                
                // Wait 3 seconds before proceeding
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Convert to wei
                const amountInWei = ethers.parseUnits(finalCostIAM.toString(), 18);
                
                // Check user balance
                const userBalance = await contract.balanceOf(address);
                if (userBalance < amountInWei) {
                    throw new Error(`Insufficient IAM balance. Required: ${finalCostIAM.toFixed(6)} IAM`);
                }
                
                statusDiv.innerHTML = '‚è≥ Sending purchase transaction...';
                statusDiv.style.color = '#a786ff';
                
                // Purchase with 100% payout to contract address
                const contractAddress = contract.target || contract.address;
                const tx = await contract.purchase(amountInWei, 100, contractAddress);
                
                statusDiv.innerHTML = '‚è≥ Waiting for transaction confirmation...';
                statusDiv.style.color = '#a786ff';
                
                await tx.wait();
                
                statusDiv.innerHTML = '‚úÖ Purchase completed! The contract will add 1 point automatically when cooldown (15 days) is over and required IAM is reached.';
                statusDiv.style.color = '#00ff88';
                
                // Reload profile after 2 seconds
                setTimeout(() => {
                    loadProfile();
                }, 2000);
                
            } catch (error) {
                console.error('Purchase point error:', error);
                
                let errorMsg = 'Error purchasing point';
                if (error.code === 4001 || error.message.includes('user denied')) {
                    errorMsg = '‚ùå Transaction was cancelled by user';
                } else if (error.code === -32002 || error.message.includes('Already processing')) {
                    errorMsg = '‚è≥ Wallet is processing another request. Please wait';
                } else if (error.message.includes('network')) {
                    errorMsg = '‚ùå Network error! Check your internet connection';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg = '‚ùå Insufficient balance to pay transaction fee';
                } else {
                    errorMsg = '‚ùå ' + (error.message || 'Unknown purchase error');
                }
                
                statusDiv.innerHTML = errorMsg;
                statusDiv.style.color = '#ff4444';
            }
            
            // Re-enable button
            purchasePointBtn.disabled = false;
            purchasePointBtn.style.opacity = '';
            purchasePointBtn.style.cursor = '';
        });
    }
    
    // Setup purchase 2 points button functionality
    function setupPurchase2PointsButton(user, contract, address) {
        const purchase2PointsBtn = document.getElementById('purchase-2-points-btn');
        const statusDiv = document.getElementById('upgrade-cap-status');
        
        if (!purchase2PointsBtn || !statusDiv) return;
        
        purchase2PointsBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            // Disable button and show loading
            purchase2PointsBtn.disabled = true;
            purchase2PointsBtn.style.opacity = '0.5';
            purchase2PointsBtn.style.cursor = 'not-allowed';
            statusDiv.innerHTML = '‚è≥ Calculating required IAM for upgrade...';
            statusDiv.style.color = '#a786ff';
            
            try {
                // Check if user is registered
                if (!(user.num && BigInt(user.num) > 0n)) {
                    throw new Error('You must be registered to purchase points');
                }
                
                // Get token price
                let tokenPrice = 0;
                try {
                    if (typeof contract.getTokenPrice === 'function') {
                        const tokenPriceRaw = await contract.getTokenPrice();
                        tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                    }
                } catch (e) {
                    console.log('Error getting token price:', e);
                }

                // Compute required IAM based on cap*3 and current totalPurchasedKind
                const cap = Number(user.binaryPointCap || 0);
                const effectiveCap = cap === 0 ? 1 : cap;
                const totalPurchased = Number(ethers.formatUnits((user.totalPurchasedKind || 0).toString(), 18));
                const requiredDai = effectiveCap * 3;
                const requiredIAM = tokenPrice > 0 ? (requiredDai / tokenPrice) : 0;
                const remainingIAM = requiredIAM > totalPurchased ? (requiredIAM - totalPurchased) : 0;
                const finalCostIAM = remainingIAM > 0 ? remainingIAM : requiredIAM;
                
                // Calculate USD equivalent
                const usdEquivalent = finalCostIAM * tokenPrice;
                
                // Show message box with token amount and USD equivalent
                statusDiv.innerHTML = `
                    <div style="background:rgba(167,134,255,0.1);border:2px solid #a786ff;border-radius:10px;padding:1rem;margin:0.5rem 0;text-align:center;">
                        <div style="color:#a786ff;font-weight:bold;font-size:1.1em;margin-bottom:0.5rem;">üéØ Contribute Toward Next Point</div>
                        <div style="color:#fff;font-size:1em;margin-bottom:0.3rem;">Token Amount: <span style="color:#ff6b35;font-weight:bold;">${finalCostIAM.toFixed(6)} IAM</span></div>
                        <div style="color:#fff;font-size:1em;">USD Equivalent: <span style="color:#a786ff;font-weight:bold;">$${usdEquivalent.toFixed(4)}</span></div>
                        <div style="color:#ccc;font-size:0.9em;margin-top:0.5rem;">Payout: 100% to Contract ‚Ä¢ Max 1 point per 15 days by contract</div>
                    </div>
                `;
                statusDiv.style.color = '#a786ff';
                
                // Wait 3 seconds before proceeding
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Convert to wei
                const amountInWei = ethers.parseUnits(finalCostIAM.toString(), 18);
                
                // Check user balance
                const userBalance = await contract.balanceOf(address);
                if (userBalance < amountInWei) {
                    throw new Error(`Insufficient IAM balance. Required: ${finalCostIAM.toFixed(6)} IAM`);
                }
                
                statusDiv.innerHTML = '‚è≥ Sending purchase transaction...';
                statusDiv.style.color = '#a786ff';
                
                // Purchase with 100% payout to contract address
                const contractAddress = contract.target || contract.address;
                const tx = await contract.purchase(amountInWei, 100, contractAddress);
                
                statusDiv.innerHTML = '‚è≥ Waiting for transaction confirmation...';
                statusDiv.style.color = '#a786ff';
                
                await tx.wait();
                
                statusDiv.innerHTML = '‚úÖ Purchase completed! The contract will add 1 point automatically when cooldown (15 days) is over and required IAM is reached.';
                statusDiv.style.color = '#00ff88';
                
                // Reload profile after 2 seconds
                setTimeout(() => {
                    loadProfile();
                }, 2000);
                
            } catch (error) {
                console.error('Purchase 2 points error:', error);
                
                let errorMsg = 'Error purchasing 2 points';
                if (error.code === 4001 || error.message.includes('user denied')) {
                    errorMsg = '‚ùå Transaction was cancelled by user';
                } else if (error.code === -32002 || error.message.includes('Already processing')) {
                    errorMsg = '‚è≥ Wallet is processing another request. Please wait';
                } else if (error.message.includes('network')) {
                    errorMsg = '‚ùå Network error! Check your internet connection';
                } else if (error.message.includes('insufficient funds')) {
                    errorMsg = '‚ùå Insufficient balance to pay transaction fee';
                } else {
                    errorMsg = '‚ùå ' + (error.message || 'Unknown purchase error');
                }
                
                statusDiv.innerHTML = errorMsg;
                statusDiv.style.color = '#ff4444';
            }
            
            // Re-enable button
            purchase2PointsBtn.disabled = false;
            purchase2PointsBtn.style.opacity = '';
            purchase2PointsBtn.style.cursor = '';
        });
    }
    
    // Update upgrade cap balance display with USD equivalent
    function updateUpgradeCapBalance(IAMBalance, tokenPrice) {
        const balanceElement = document.getElementById('upgrade-cap-balance');
        const balanceUsdElement = document.getElementById('upgrade-cap-balance-usd');
        
        if (balanceElement && balanceUsdElement) {
            const balanceIAM = Number(ethers.formatUnits(IAMBalance, 18));
            const balanceUSD = balanceIAM * tokenPrice;
            
            balanceElement.textContent = `${balanceIAM.toFixed(6)} IAM`;
            balanceUsdElement.textContent = `‚âà $${balanceUSD.toFixed(2)}`;
        }
    }
    
    async function loadProfile() {
        const content = document.getElementById('profile-content');
        content.innerHTML = '<div class="loading">Loading information...</div>';
        
        // Clear any existing caches to ensure fresh data
        if (window.clearUserProfileCache) {
            window.clearUserProfileCache();
        }
        if (window.cachedUserProfile) {
            window.cachedUserProfile = null;
        }
        
        try {
            if (!window.connectWallet) throw new Error('Wallet connection is not active');
            const { contract, address, provider } = await window.connectWallet();
            if (!contract || !address) throw new Error('Wallet connection failed');
            // User struct information with error handling
            async function fetchUserSafe(addr) {
                try {
                    return await contract.users(addr);
                } catch (e) {
                    console.error('users(address) call failed:', e);
                    throw new Error('Failed to fetch user data from contract');
                }
            }
            const user = await fetchUserSafe(address);
            // Balances
            const maticBalance = await provider.getBalance(address);
            const IAMBalance = await contract.balanceOf(address);
            
            // Function to format large numbers - show full values without abbreviations
            function formatLargeNumber(num) {
                return num.toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
            
            // Calculate IAM USD equivalent
            let IAMUsdValue = 0;
            let tokenPrice = 0;
            try {
                if (typeof contract.getTokenPrice === 'function') {
                    const tokenPriceRaw = await contract.getTokenPrice();
                    tokenPrice = Number(ethers.formatUnits(tokenPriceRaw, 18));
                    const IAMAmount = Number(ethers.formatUnits(IAMBalance, 18));
                    IAMUsdValue = IAMAmount * tokenPrice;
                }
            } catch (e) {
                console.log('Error getting token price:', e);
            }
            
            // DAI
            let daiBalance = '0';
            try {
                const daiAddress = window.DAI_ADDRESS || '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063';
                const daiAbi = window.DAI_ABI || [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}];
                const dai = new ethers.Contract(daiAddress, daiAbi, provider);
                const daiRaw = await dai.balanceOf(address);
                daiBalance = ethers.formatUnits(daiRaw, 18);
            } catch {}
            // Index (changed from index to num)
            const IAMId = user.num ? `IAM${user.num.toString().padStart(5, '0')}` : '-';
            // Display
            content.innerHTML = `
                <div class="balance-box">
                    <div class="balance-item">
                        <div class="balance-label">IAM</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatUnits(IAMBalance.toString(), 18)))}</span>
                        <div style="font-size:0.8rem;color:#a786ff;margin-top:2px;">‚âà $${IAMUsdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">MATIC</div>
                        <span class="balance-value" title="${Number.parseFloat(ethers.formatEther(maticBalance.toString())).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(ethers.formatEther(maticBalance.toString())))}</span>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">DAI</div>
                        <span class="balance-value" title="${Number.parseFloat(daiBalance.toString()).toLocaleString('en-US', {maximumFractionDigits: 4})}">${formatLargeNumber(Number.parseFloat(daiBalance.toString()))}</span>
                    </div>
                </div>
                <div class="withdrawal-buttons" style="display:flex;gap:0.8rem;justify-content:center;margin-bottom:1rem;flex-wrap:wrap;">
                  <button id="claim-btn" title="Commission withdrawal is only possible once every 12 hours and if you have points to withdraw. If you don't have points or 12 hours haven't passed yet, withdrawal is not possible." style="background:linear-gradient(90deg,#00ff88,#a786ff);color:#181c2a;font-weight:bold;border:none;border-radius:8px;padding:0.7em 1.5em;font-size:0.95em;cursor:pointer;box-shadow:0 1px 4px #00ff8840;display:inline-flex;align-items:center;gap:0.4em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1em;'>üí∏</span> Withdraw Commission <span id="claim-timer" style="font-size:0.8em;margin-right:0.3em;"></span></button>
                  <button id="upgrade-cap-btn" title="Upgrade binary points cap using IAM tokens. The more you upgrade, the higher your points cap becomes." style="background:linear-gradient(90deg,#ff6b35,#ff8e53);color:#181c2a;font-weight:bold;border:none;border-radius:8px;padding:0.7em 1.5em;font-size:0.95em;cursor:pointer;box-shadow:0 1px 4px #ff6b3540;display:inline-flex;align-items:center;gap:0.4em;transition:box-shadow 0.2s,transform 0.2s;"><span style='font-size:1em;'>üìà</span> Upgrade Cap <span id="upgrade-timer" style="font-size:0.8em;margin-right:0.3em;"></span></button>
                </div>
                
                                                   <!-- Upgrade Cap Modal -->
                  <div id="upgrade-cap-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px);">
                      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(35,41,70,0.98);border-radius:18px;padding:2rem;max-width:600px;width:90%;border:2px solid #ff6b3533;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
                          <div style="text-align:center;margin-bottom:1.5rem;">
                              <h3 style="color:#ff6b35;margin:0;font-size:1.5em;">üìà Upgrade Binary Points Cap</h3>
                              <p style="color:#ccc;margin:0.5rem 0;font-size:0.9em;">Upgrade cost = (Cap √ó 3 DAI) worth of IAM. Contract adds max 1 point per purchase when 15-day cooldown passes and required IAM is accumulated.</p>
                          </div>
                          
                          <div style="margin-bottom:1.5rem;">
                              <div style="margin-top:0.5rem;font-size:0.9em;color:#ccc;">
                                  <span>Current Balance: </span>
                                  <span id="upgrade-cap-balance" style="color:#00ff88;font-weight:bold;">Loading...</span>
                                  <div id="upgrade-cap-balance-usd" style="margin-top:2px;color:#a786ff;font-size:0.8em;">‚âà $0.00</div>
                              </div>
                              <div style="margin-top:0.5rem;font-size:0.9em;color:#ccc;">
                                  <span>Current Cap: </span>
                                  <span id="upgrade-cap-current" style="color:#a786ff;font-weight:bold;">Loading...</span>
                              </div>
                          </div>
                          
                          <div style="display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;">
                              <button id="purchase-point-btn" style="background:linear-gradient(90deg,#00ff88,#a786ff);color:#181c2a;border:none;border-radius:8px;padding:0.8rem 1.5rem;font-weight:bold;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:0.4em;"><span style='font-size:1em;'>üéØ</span> Purchase Toward Upgrade</button>
                              <button id="purchase-2-points-btn" style="background:linear-gradient(90deg,#a786ff,#ff6b35);color:#181c2a;border:none;border-radius:8px;padding:0.8rem 1.5rem;font-weight:bold;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:0.4em;"><span style='font-size:1em;'>üéØ</span> Purchase Toward Upgrade</button>
                              <button id="upgrade-cap-cancel" style="background:rgba(255,255,255,0.1);color:#ccc;border:1px solid #666;border-radius:8px;padding:0.8rem 1.5rem;cursor:pointer;transition:all 0.2s;">Cancel</button>
                          </div>
                          
                          <div id="upgrade-cap-status" style="margin-top:1rem;text-align:center;font-size:0.9em;min-height:1.5em;"></div>
                      </div>
                  </div>
                <div class="profile-row"><span class="profile-label">Wallet Address:</span><span class="profile-value">${address}</span></div>
                                 <div class="profile-row"><span class="profile-label">ID:</span><span class="profile-value">${IAMId}</span></div>
                                 <div class="profile-row"><span class="profile-label">ID Number:</span><span class="profile-value">${user.num}</span></div>
                <div class="profile-row"><span class="profile-label">Active:</span><span class="profile-value">${(user.num && BigInt(user.num) > 0n) ? 'Yes' : 'No'}</span></div>
                <div class="profile-row"><span class="profile-label">Binary Points:</span><span class="profile-value">${user.binaryPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Binary Points Cap:</span><span class="profile-value">${user.binaryPointCap}</span></div>
                <div class="profile-row"><span class="profile-label">Claimed Points:</span><span class="profile-value">${user.binaryPointsClaimed}</span></div>
                <div class="profile-row"><span class="profile-label">Total Purchases:</span><span class="profile-value"><span id="profile-purchased-kind">--</span><div id="profile-purchased-kind-usd" style="font-size:0.9em;color:#a786ff;margin-top:2px;"></div></span></div>
                <div class="profile-row"><span class="profile-label">Upgrade Time:</span><span class="profile-value">${formatDateTime(user.upgradeTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Last Points Withdrawal:</span><span class="profile-value">${formatDateTime(user.lastClaimTime)}</span></div>
                <div class="profile-row"><span class="profile-label">Left Points:</span><span class="profile-value">${user.leftPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Right Points:</span><span class="profile-value">${user.rightPoints}</span></div>
                <div class="profile-row"><span class="profile-label">Left Wallets Count:</span><span class="profile-value" id="profile-left-wallets">Calculating...</span></div>
                <div class="profile-row"><span class="profile-label">Right Wallets Count:</span><span class="profile-value" id="profile-right-wallets">Calculating...</span></div>
                <div class="profile-row"><span class="profile-label">Registration Date:</span><span class="profile-value">${formatDateTime(user.registrationDate)}</span></div>
                <div class="profile-row"><span class="profile-label">Parent Address:</span><span class="profile-value">${user.parent && user.parent !== '0x0000000000000000000000000000000000000000' ? user.parent : 'None'}</span></div>
                <div class="profile-row"><span class="profile-label">Left Child Address:</span><span class="profile-value">${user.leftChild && user.leftChild !== '0x0000000000000000000000000000000000000000' ? user.leftChild : 'None'}</span></div>
                <div class="profile-row"><span class="profile-label">Right Child Address:</span><span class="profile-value">${user.rightChild && user.rightChild !== '0x0000000000000000000000000000000000000000' ? user.rightChild : 'None'}</span></div>
                                 <div class="profile-row" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                     <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                         <span class="profile-label">Referral Reward:</span>
                         <span class="profile-value" id="profile-refclimed">-- IAM</span>
                     </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span class="profile-label">USD Value:</span>
                        <span class="profile-value" id="profile-refclimed-usd">$0.00</span>
                    </div>
                     
                 </div>
            `;

            // Fill Total Purchases and Referral Reward values (scientific/compact)
            (function(){
                function sci3(n){
                    const v = Number(n);
                    if(!isFinite(v) || v===0) return '0';
                    const a = Math.abs(v);
                    if(a >= 1e6 || a < 1e-2) return v.toExponential(2).replace('e','E');
                    return Number(v.toPrecision(3)).toString();
                }
                try {
                    const tpEl = document.getElementById('profile-purchased-kind');
                    const tpUsdEl = document.getElementById('profile-purchased-kind-usd');
                    const rrEl = document.getElementById('profile-refclimed');
                    const rrUsdEl = document.getElementById('profile-refclimed-usd');
                    if (tpEl) {
                        const tpFull = ethers.formatUnits((user.totalPurchasedKind||0).toString(), 18).split('.')[0];
                        tpEl.textContent = tpFull + ' IAM';
                        if (tpUsdEl) {
                            const usd = (typeof tokenPrice==='number' ? tokenPrice : 0) * Number(tpFull);
                            tpUsdEl.textContent = '‚âà $' + (isFinite(usd) ? usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00');
                        }
                    }
                    if (rrEl) {
                        const refclimed = user.refclimed || 0;
                        const rrFull = ethers.formatUnits(refclimed.toString(), 18);
                        const rrFullInt = rrFull.split('.')[0];
                        rrEl.textContent = rrFullInt + ' IAM';
                        rrEl.title = rrFull + ' IAM';
                        if (rrUsdEl) {
                            const usd = (typeof tokenPrice==='number' ? tokenPrice : 0) * Number(rrFull);
                            rrUsdEl.textContent = '$' + (isFinite(usd) ? usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00');
                            rrUsdEl.title = '$' + (isFinite(usd) ? usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0.00');
                        }
                    }
                } catch(_) {}
            })();

            setTimeout(function() {
              
              // Claim button (commission withdrawal)
              const claimBtn = document.getElementById('claim-btn');
              if (claimBtn) {
                claimBtn.addEventListener('click', async function(e) {
                  console.log('Claim button clicked!'); // for debugging
                  claimBtn.disabled = true;
                  claimBtn.style.opacity = '0.5';
                  claimBtn.style.cursor = 'not-allowed';
                  let claimMsg = document.getElementById('claim-msg');
                  if (!claimMsg) {
                    claimMsg = document.createElement('div');
                    claimMsg.id = 'claim-msg';
                    claimBtn.parentElement.parentElement.insertBefore(claimMsg, claimBtn.parentElement.nextSibling);
                  }
                  claimMsg.style.display = 'block';
                  claimMsg.style.opacity = '1';
                  claimMsg.style.background = 'rgba(167,134,255,0.08)';
                  claimMsg.style.border = '1.5px solid #a786ff';
                  claimMsg.style.borderRadius = '10px';
                  claimMsg.style.padding = '1em 1.2em';
                  claimMsg.style.marginBottom = '1.2rem';
                  claimMsg.style.textAlign = 'center';
                  claimMsg.style.fontSize = '1.07em';
                  claimMsg.style.boxShadow = '0 2px 8px #a786ff22';
                  claimMsg.style.whiteSpace = 'pre-line';
                  
                  // Display specific message for claim operation
                  claimMsg.innerHTML = '<b>üí∏ Commission Withdrawal Operation:</b><br>‚Ä¢ This operation withdraws your binary rewards<br>‚Ä¢ Withdrawal is only possible once every 12 hours<br>‚Ä¢ You must have active points<br>‚Ä¢ If you don\'t have points or 12 hours haven\'t passed, withdrawal is not possible<br><br><b>üîç Checking conditions...</b>';
                  claimMsg.style.color = '#a786ff';
                  
                  try {
                    const { contract, address } = await window.connectWallet();
                    const user = await fetchUserSafe(address);
                    const now = Math.floor(Date.now() / 1000);
                    
                    // Check withdrawal conditions
                    if (!(user.num && BigInt(user.num) > 0n)) {
                      throw new Error('Your account is not active. You must register first.');
                    }
                    
                    if (user.binaryPoints == 0) {
                      throw new Error('You have no points to withdraw.');
                    }
                    
                    if (now < Number(user.lastClaimTime) + 12 * 3600) {
                      const remain = Math.ceil((Number(user.lastClaimTime) + 12 * 3600 - now) / 3600);
                      throw new Error(`Still ${remain} hours remaining until next withdrawal.`);
                    }
                    
                  let claimMsg = document.getElementById('claim-msg');
                  if (!claimMsg) {
                    claimMsg = document.createElement('div');
                    claimMsg.id = 'claim-msg';
                    claimBtn.parentElement.parentElement.insertBefore(claimMsg, claimBtn.parentElement.nextSibling);
                  }
                  claimMsg.innerHTML = '‚è≥ Sending commission withdrawal request...';
                  claimMsg.style.color = '#00ff88';
                  
                  // Call claim function
                  const tx = await contract.claim();
                  
                  claimMsg.innerHTML = '‚è≥ Waiting for transaction confirmation in wallet...';
                  claimMsg.style.color = '#a786ff';
                  
                  await tx.wait();
                  
                  claimMsg.innerHTML = '‚úÖ Commission withdrawal completed successfully!';
                  claimMsg.style.color = '#00ff88';
                  claimMsg.style.background = 'rgba(0,255,136,0.08)';
                  claimMsg.style.border = '1.5px solid #00ff88';
                  
                  setTimeout(() => {
                    claimMsg.style.display = 'none';
                    loadProfile(); // Reload profile
                  }, 2000);
                  
                } catch(err) {
                  console.error('Claim error:', err); // for debugging
                  let claimMsg = document.getElementById('claim-msg');
                  if (!claimMsg) {
                    claimMsg = document.createElement('div');
                    claimMsg.id = 'claim-msg';
                    claimBtn.parentElement.parentElement.insertBefore(claimMsg, claimBtn.parentElement.nextSibling);
                  }
                  let errorMsg = 'Error in commission withdrawal';
                  
                  if (err.code === 4001 || err.message.includes('user denied')) {
                    errorMsg = '‚ùå Transaction was cancelled by user.';
                  } else if (err.code === -32002 || err.message.includes('Already processing')) {
                    errorMsg = '‚è≥ Wallet is processing another request. Please wait.';
                  } else if (err.message.includes('network')) {
                    errorMsg = '‚ùå Network error! Check your internet connection.';
                  } else if (err.message.includes('insufficient funds')) {
                    errorMsg = '‚ùå Insufficient balance to pay transaction fee.';
                  } else {
                    errorMsg = '‚ùå ' + (err.message || 'Unknown withdrawal error');
                  }
                  
                  claimMsg.innerHTML = errorMsg;
                  claimMsg.style.color = '#ff4444';
                  claimMsg.style.background = 'rgba(255,68,68,0.08)';
                  claimMsg.style.border = '1.5px solid #ff4444';
                  
                  setTimeout(() => {
                    claimMsg.style.display = 'none';
                  }, 5000);
                  }
                  
                  claimBtn.disabled = false;
                  claimBtn.style.opacity = '';
                  claimBtn.style.cursor = '';
                });
              }
            }, 100);
            
                         // Setup referral link copy button
             if (typeof setupReferralCopy === 'function') {
                 setupReferralCopy();
             }
             
             // Direct setup for copy button
             const copyBtn = document.getElementById('copyProfileReferral');
             if (copyBtn) {
                 copyBtn.addEventListener('click', async () => {
                     try {
                         const linkElement = document.getElementById('profile-referral-link');
                         if (linkElement) {
                             const referralLink = linkElement.textContent;
                             
                             // Try modern clipboard API first
                             if (navigator.clipboard && navigator.clipboard.writeText) {
                                 await navigator.clipboard.writeText(referralLink);
                                 copyBtn.textContent = '⁄©Ÿæ€å ÿ¥ÿØ!';
                                 setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                             } else {
                                 // Fallback for older browsers
                                 const textArea = document.createElement('textarea');
                                 textArea.value = referralLink;
                                 document.body.appendChild(textArea);
                                 textArea.select();
                                 document.execCommand('copy');
                                 document.body.removeChild(textArea);
                                 copyBtn.textContent = '⁄©Ÿæ€å ÿ¥ÿØ!';
                                 setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                             }
                         } else {
                             copyBtn.textContent = 'ÿÆÿ∑ÿß: ŸÑ€åŸÜ⁄© €åÿßŸÅÿ™ ŸÜÿ¥ÿØ';
                             setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                         }
                     } catch (error) {
                         console.error('Copy error:', error);
                         copyBtn.textContent = 'ÿÆÿ∑ÿß ÿØÿ± ⁄©Ÿæ€å';
                         setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                     }
                 });
             }
             
             // Calculate and display left and right wallet counts
             if (typeof updateWalletCountsDisplay === 'function') {
                 setTimeout(async () => {
                     await updateWalletCountsDisplay();
                 }, 1000); // 1 second delay to ensure complete loading
             }
             
            // Initialize withdrawal timers
            startWithdrawalTimers(user);
            
            // Setup upgrade cap balance display
            setTimeout(() => {
                updateUpgradeCapBalance(IAMBalance, tokenPrice);
            }, 100);
            
                          // Setup upgrade cap button
              if (typeof setupUpgradeCapButton === 'function') {
                  setTimeout(() => {
                      setupUpgradeCapButton(user, contract, address);
                  }, 100);
              }
              
              // Setup purchase point button
              setTimeout(() => {
                  setupPurchasePointButton(user, contract, address);
              }, 200);
              
              // Setup purchase 2 points button
              setTimeout(() => {
                  setupPurchase2PointsButton(user, contract, address);
              }, 300);
                 } catch (e) {
             content.innerHTML = `<div class="error-message">Error: ${e.message || e}</div>`;
         }
    }
    window.addEventListener('DOMContentLoaded', async function() {
        if (typeof window.ethereum !== 'undefined') {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts && accounts.length > 0) {
                await loadProfile();
            }
        }
    });
    </script>
    
    
</body>
</html> 
