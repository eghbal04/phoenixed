<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Referral Register</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b1220; --panel:#111a2e; --border:#22304a; --accent:#00ff88; --text:#cfd7ea; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:900px; margin:20px auto; padding:16px; }
    .card{ background:linear-gradient(135deg,#0f172a 80%,#0b1220 100%); border:1px solid var(--border); border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,0.35); }
    .title{ font-family: 'Montserrat', sans-serif; font-weight:700; font-size:1.2rem; text-align:right; margin-bottom:10px; }
    .form-group{ margin:12px 0; }
    label{ display:block; margin-bottom:6px; color:#a786ff; font-weight:600; }
    input{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); background:#0f1420; color:var(--text); font-size:0.95rem; }
    .row{ display:flex; gap:10px; align-items:center; }
    .btn{ width:100%; background:linear-gradient(90deg,#00ff88,#00cc66); color:#0b1220; border:none; border-radius:10px; padding:12px 14px; font-weight:700; cursor:pointer; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .status{ margin-top:8px; min-height:20px; font-size:.9rem; }
    .info{ font-size:.85rem; color:#94a3b8; }
    .collapsible-header{ cursor:pointer; user-select:none; display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(0,255,136,0.05); border:1px solid rgba(0,255,136,0.2); border-radius:8px; transition:all 0.3s ease; }
    .collapsible-header:hover{ background:rgba(0,255,136,0.1); border-color:rgba(0,255,136,0.3); }
    .collapsible-header.active{ background:rgba(0,255,136,0.1); border-color:rgba(0,255,136,0.4); }
    .collapsible-icon{ font-size:1.2rem; transition:transform 0.3s ease; color:#00ff88; }
    .collapsible-header.active .collapsible-icon{ transform:rotate(180deg); }
    .collapsible-content{ max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
    .collapsible-content.active{ max-height:2000px; }
    .collapsible-body{ padding:12px; background:rgba(167,134,255,0.05); border:1px solid rgba(167,134,255,0.2); border-top:none; border-radius:0 0 8px 8px; font-size:0.9rem; line-height:1.6; color:#cfd7ea; }
    .collapsible-body h4{ color:#a786ff; margin:8px 0 6px 0; font-size:0.95rem; }
    .collapsible-body ul{ margin:4px 0; padding-left:20px; color:#94a3b8; }
    .collapsible-body li{ margin:4px 0; }
    .language-selector{ margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .language-btn{ padding: 6px 12px; background: rgba(167, 134, 255, 0.1); border: 1px solid rgba(167, 134, 255, 0.3); border-radius: 6px; color: #cfd7ea; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease; }
    .language-btn:hover{ background: rgba(167, 134, 255, 0.2); border-color: rgba(167, 134, 255, 0.5); }
    .language-btn.active{ background: rgba(167, 134, 255, 0.3); border-color: #a786ff; color: #a786ff; font-weight: 600; }
    .language-btn-register{ padding: 6px 12px; background: rgba(167, 134, 255, 0.1); border: 1px solid rgba(167, 134, 255, 0.3); border-radius: 6px; color: #cfd7ea; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease; }
    .language-btn-register:hover{ background: rgba(167, 134, 255, 0.2); border-color: rgba(167, 134, 255, 0.5); }
    .language-btn-register.active{ background: rgba(167, 134, 255, 0.3); border-color: #a786ff; color: #a786ff; font-weight: 600; }
    /* RTL Support for Persian and Arabic */
    .collapsible-body.rtl{ direction: rtl; text-align: right; }
    .collapsible-body.rtl h4{ text-align: right; }
    .collapsible-body.rtl ul{ padding-right: 20px; padding-left: 0; list-style-position: inside; }
    .collapsible-body.rtl ol{ padding-right: 25px; padding-left: 0; list-style-position: inside; }
    .collapsible-body.rtl li{ text-align: right; }
    .collapsible-body.rtl .language-selector{ justify-content: flex-end; flex-direction: row-reverse; }
    #benefits-title.rtl{ direction: rtl; text-align: right; }
    #benefits-toggle.rtl{ direction: rtl; text-align: right; }
    #benefits-toggle.rtl .collapsible-icon{ order: -1; }
    #register-guide-title.rtl{ direction: rtl; text-align: right; }
    #register-guide-toggle.rtl{ direction: rtl; text-align: right; }
    #register-guide-toggle.rtl .collapsible-icon{ order: -1; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.10.0/ethers.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="title">Buy IAM</div>

      <!-- DAI Information Section -->
      <div style="background: rgba(93, 160, 255, 0.1); border: 1px solid rgba(93, 160, 255, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 12px; margin-top: 8px; font-size: 0.9rem; line-height: 1.6; color: #cfd7ea;">
        <div style="font-weight: 600; color: #5da0ff; margin-bottom: 8px;">💵 DAI Token Information</div>
        <div style="margin-bottom: 8px; font-size: 0.85rem; color: #94a3b8;">
          <strong>DAI Contract Address (Polygon):</strong>
          <div style="background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding: 8px; border-radius: 6px; margin-top: 6px; font-family: monospace; font-size: 0.8rem; word-break: break-all; color: #cfe3ff;">
            <span id="dai-address">0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063</span>
            <button onclick="copyDAIAddress()" style="margin-left: 8px; padding: 4px 8px; background: rgba(93, 160, 255, 0.2); border: 1px solid rgba(93, 160, 255, 0.4); border-radius: 4px; color: #5da0ff; cursor: pointer; font-size: 0.75rem;">Copy</button>
          </div>
        </div>
        <div style="margin-top: 10px; font-size: 0.85rem; color: #94a3b8;">
          <strong>How to Get DAI:</strong>
          <ul style="margin: 6px 0 0 0; padding-left: 20px; color: #94a3b8;">
            <li>Buy DAI from exchanges (Binance, Coinbase, etc.) and transfer to Polygon network</li>
            <li>Swap any token from your SafePal or MetaMask wallet to DAI on Polygon using DEXs like QuickSwap, Uniswap V3, or SushiSwap</li>
            <li>Bridge tokens from other networks to Polygon and then swap to DAI</li>
            <li>Use centralized exchanges that support Polygon network for direct DAI purchase</li>
          </ul>
        </div>
      </div>

      <!-- Buy Section (copied behavior from register.html) -->
      <div id="buy-section" style="margin:8px 0; padding:8px; border-radius:10px; border:1px solid rgba(0,255,136,0.3); background: linear-gradient(135deg, rgba(0,255,136,0.05), rgba(167,134,255,0.05)); box-shadow: 0 4px 16px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.03);">
        <!-- Quick Swap: DAI to IAM -->
        <div style="background: rgba(93, 160, 255, 0.1); border: 1px solid rgba(93, 160, 255, 0.3); border-radius: 10px; padding: 12px; margin-top: 12px;">
          <div style="font-size: 0.85rem; color: #cfe3ff; margin-bottom: 10px; font-weight: 600;">
            💱 Quick Swap: DAI → IAM
          </div>
          <!-- DAI Amount Input -->
          <div style="margin-bottom: 8px;">
            <label style="display: block; font-size: 0.75rem; color: #cfe3ff; margin-bottom: 4px;">DAI Amount</label>
            <input type="number" id="quick-swap-dai-amount" placeholder="Your dollar amount (USD)" step="0.01" min="0" style="width: 100%; background: #0f1420; border: 1px solid var(--border); color: #cfd7ea; border-radius: 8px; padding: 10px; font-size: 1rem; box-sizing: border-box;">
          </div>
          <!-- Stats row (Your IAM, Your DAI) -->
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; font-size:0.78rem;">
            <div style="background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); padding:4px 8px; border-radius:8px; color:#cfe3ff;">
              Your IAM: <b id="buy-current-iam" style="color:#a786ff;">...</b>
            </div>
            <div style="background: rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08); padding:4px 8px; border-radius:8px; color:#cfe3ff;">
              Your DAI: <b id="quick-swap-dai-balance" style="color:#5da0ff;">...</b>
            </div>
          </div>
          <!-- Swap Button -->
          <button type="button" id="quick-swap-btn" class="btn">
            🔄 Swap DAI to IAM
          </button>
          <!-- Status Message -->
          <div id="quick-swap-status" class="status" style="margin-top: 8px; font-size: 0.8rem; min-height: 20px;"></div>
          <!-- Info about registration DAI requirement -->
          <div style="margin-top: 10px; padding: 8px; background: rgba(0,255,136,0.05); border: 1px solid rgba(0,255,136,0.2); border-radius: 8px; font-size: 0.75rem; color: #94a3b8; line-height: 1.5;">
            <strong style="color: #00ff88;">💡 Note:</strong> After swapping DAI to IAM, if you need more IAM for registration, the required DAI amount will be automatically filled in the field above. You can swap it to IAM, and then the Register button will be enabled for you to complete registration.
          </div>
        </div>
      </div>

      <div style="background: rgba(167, 134, 255, 0.1); border: 1px solid rgba(167, 134, 255, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 16px; margin-top: 16px; font-size: 0.9rem; line-height: 1.6; color: #cfd7ea;">
        <div style="font-weight: 600; color: #a786ff; margin-bottom: 8px;">🌟 About IAM Platform</div>
        <div style="margin-bottom: 8px;">IAM is a decentralized platform that empowers users to build and manage their network through a unique referral system. Join our growing community and start your journey today.</div>
        <div style="margin-bottom: 8px;"><strong>Key Features:</strong></div>
        <ul style="margin: 0; padding-left: 20px; color: #94a3b8;">
          <li>Decentralized identity management</li>
          <li>Network growth through referrals</li>
          <li>Transparent and secure transactions</li>
          <li>Community-driven ecosystem</li>
        </ul>
      </div>

      <!-- Collapsible Section: IAM Token Benefits & Income Plan -->
      <div style="margin-bottom: 16px; margin-top: 16px;">
        <div class="collapsible-header" id="benefits-toggle">
          <div style="font-weight: 600; color: #00ff88; font-size: 0.95rem;" id="benefits-title">💰 IAM Token Benefits & Income Plan</div>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="collapsible-content" id="benefits-content">
          <div class="collapsible-body">
            <!-- Language Selector -->
            <div class="language-selector">
              <span style="color: #a786ff; font-size: 0.85rem; font-weight: 600;">🌐 Language:</span>
              <button class="language-btn active" data-lang="en">English</button>
              <button class="language-btn" data-lang="zh">中文</button>
              <button class="language-btn" data-lang="ru">Русский</button>
              <button class="language-btn" data-lang="ar">العربية</button>
              <button class="language-btn" data-lang="fa">فارسی</button>
            </div>

            <!-- Content sections with IDs for language switching -->
            <h4 id="benefits-heading">🎯 IAM Token Benefits:</h4>
            <ul id="benefits-list"></ul>

            <h4 id="income-heading" style="margin-top: 16px;">💵 Income Generation Plan:</h4>
            <ul id="income-list"></ul>

            <h4 id="growth-heading" style="margin-top: 16px;">📈 Growth Potential:</h4>
            <ul id="growth-list"></ul>
          </div>
        </div>
      </div>

      <!-- Collapsible Section: How to Register -->
      <div style="margin-bottom: 16px; margin-top: 16px;">
        <div class="collapsible-header" id="register-guide-toggle">
          <div style="font-weight: 600; color: #00ff88; font-size: 0.95rem;" id="register-guide-title">📝 How to Register</div>
          <span class="collapsible-icon">▼</span>
        </div>
        <div class="collapsible-content" id="register-guide-content">
          <div class="collapsible-body" id="register-guide-body">
            <!-- Language Selector -->
            <div class="language-selector">
              <span style="color: #a786ff; font-size: 0.85rem; font-weight: 600;">🌐 Language:</span>
              <button class="language-btn-register active" data-lang="en">English</button>
              <button class="language-btn-register" data-lang="zh">中文</button>
              <button class="language-btn-register" data-lang="ru">Русский</button>
              <button class="language-btn-register" data-lang="ar">العربية</button>
              <button class="language-btn-register" data-lang="fa">فارسی</button>
            </div>

            <!-- Content sections -->
            <h4 id="register-guide-heading">📋 Registration Steps:</h4>
            <ol id="register-steps-list" style="margin: 8px 0; padding-left: 25px; color: #94a3b8;"></ol>

            <h4 id="register-requirements-heading" style="margin-top: 16px;">✅ Requirements:</h4>
            <ul id="register-requirements-list" style="margin: 8px 0; padding-left: 20px; color: #94a3b8;"></ul>

            <h4 id="register-important-heading" style="margin-top: 16px;">⚠️ Important Notes:</h4>
            <ul id="register-important-list" style="margin: 8px 0; padding-left: 20px; color: #94a3b8;"></ul>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="new-user-address">New User Address (Your Wallet)</label>
        <div class="row">
          <input id="new-user-address" type="text" placeholder="0x..." autocomplete="off" readonly style="background:#2a2a2a; color:#888; cursor:not-allowed;" />
        </div>
      </div>

      <button id="register-btn" class="btn" disabled>Register</button>
      <div id="status" class="status"></div>
      <div class="info" id="referral-info">Referrer and Upper are auto-set from referral link.</div>
    </div>
  </div>

  <script>
  // Minimal config - use same contract as register.html
  const IAM_ADDRESS = window.IAM_ADDRESS || '0xa4C37107AbaeD664978e5f6db79249Ad08Fe0dBf';
  const DAI_ADDRESS = window.DAI_ADDRESS || '0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063';

  // Minimal ABI
  const IAM_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function getRegPrice() view returns (uint256)",
    "function registrationPrice() view returns (uint256)",
    "function getRegistrationPrice() view returns (uint256)",
    "function getTokenPrice() view returns (uint256)",
    "function registerAndActivate(address referrer, address upper, address newUser) returns (bool)",
    "function users(address) view returns (uint256 num, uint256 index, address referrer, address left, address right, bool active)"
  ];

  const $ = (id) => document.getElementById(id);
  const statusEl = $('status');
  const registerBtn = $('register-btn');
  const newUserInput = $('new-user-address');

  // Copy DAI Address function
  window.copyDAIAddress = function() {
    const daiAddress = document.getElementById('dai-address').textContent;
    const copyBtn = document.querySelector('[onclick="copyDAIAddress()"]');
    navigator.clipboard.writeText(daiAddress).then(() => {
      if (copyBtn) {
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'Copied!';
        copyBtn.style.background = 'rgba(0,255,136,0.3)';
        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.style.background = 'rgba(93, 160, 255, 0.2)';
        }, 2000);
      }
    }).catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy address. Please copy manually: ' + daiAddress);
    });
  };

  let provider, signer, me, contract;
  let requiredIam = 0;
  let myIam = 0;
  let referrerAddress = null; // Will be set from URL or connected wallet

  function setStatus(msg, color){ statusEl.textContent = msg || ''; statusEl.style.color = color || '#cfd7ea'; }

  // Get referrer from URL parameter
  function getReferrerFromURL(){
    const urlParams = new URLSearchParams(window.location.search);
    const ref = urlParams.get('ref') || urlParams.get('referrer') || urlParams.get('r');
    if (ref && /^0x[a-fA-F0-9]{40}$/.test(ref)) {
      return ref;
    }
    return null;
  }

  // Check if user is active/registered
  async function checkUserActive(userAddress){
    try {
      if (!contract) return false;
      const userData = await contract.users(userAddress);
      // Support both old (index) and new (num) contracts
      const userNum = userData.num !== undefined ? userData.num : userData.index;
      const isActive = !!(userNum && BigInt(userNum) > 0n);
      return isActive;
    } catch(e) {
      console.warn('Error checking user status:', e);
      return false;
    }
  }

  async function connect(){
    if (!window.ethereum) throw new Error('Please install MetaMask');
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    me = await signer.getAddress();
    
    contract = new ethers.Contract(IAM_ADDRESS, IAM_ABI, signer);
    
    // Check if user is already active/registered - redirect to home if yes
    const isActive = await checkUserActive(me);
    if (isActive) {
      setStatus('✅ Wallet is already registered and active. Redirecting to home...', '#00ff88');
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 1500);
      return;
    }
    
    // Auto-fill new user address with connected wallet
    newUserInput.value = me;
    
    // Get referrer from URL or use connected wallet
    referrerAddress = getReferrerFromURL() || me;
    const infoEl = document.getElementById('referral-info');
    if (referrerAddress && referrerAddress !== me) {
      infoEl.textContent = `Referrer/Upper: ${referrerAddress.substring(0,6)}...${referrerAddress.substring(38)} (from referral link)`;
    } else {
      infoEl.textContent = 'Referrer/Upper: Your wallet address (self-referral)';
    }
  }

  async function fetchRegPrice(){
    try {
      if (contract.getRegPrice) { return await contract.getRegPrice(); }
    } catch(_){}
    try { if (contract.getRegistrationPrice) { return await contract.getRegistrationPrice(); } } catch(_){ }
    try { if (contract.registrationPrice) { return await contract.registrationPrice(); } } catch(_){ }
    return ethers.parseUnits('100','wei');
  }

  async function refresh(){
    try {
      const priceWei = await fetchRegPrice();
      requiredIam = Number(ethers.formatUnits(priceWei, 18));

      const balWei = await contract.balanceOf(me);
      myIam = Number(ethers.formatUnits(balWei, 18));

      // Update Buy IAM mini-cards
      const curEl = document.getElementById('buy-current-iam');
      if (curEl) curEl.textContent = myIam.toFixed(2);
      try { await updateReferralDaiBalance(); } catch(_){}
      try { await autoFillQuickSwapDai(); } catch(_){}

      if (myIam >= requiredIam && requiredIam > 0) {
        registerBtn.disabled = false;
      } else {
        registerBtn.disabled = true;
      }
    } catch(e){ setStatus('Refresh failed: ' + (e.message||e), '#ff6b6b'); }
  }

  async function doRegister(){
    try{
      setStatus('Preparing registration...', '#5da0ff');
      
      // Use connected wallet address as new user (must be active/registered user)
      const newUser = me;
      if (!newUser || !/^0x[a-fA-F0-9]{40}$/.test(newUser)){
        setStatus('Invalid wallet address', '#ff6b6b');
        return;
      }
      
      // Referrer and Upper are same - from referral link or connected wallet
      const referrer = referrerAddress || me;
      const upper = referrer; // Same as referrer
      
      registerBtn.disabled = true;
      setStatus('Sending registration transaction...', '#5da0ff');
      const tx = await contract.registerAndActivate(referrer, upper, newUser);
      setStatus('Waiting for confirmation...', '#5da0ff');
      await tx.wait();
      setStatus('✅ Registered successfully', '#00ff88');
      await refresh();
      // Redirect to home page after successful registration
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2000);
    } catch(e){
      let errorMsg = '❌ Register failed: ' + (e && e.message ? e.message : e);
      if (/already registered|Already registered/i.test(errorMsg)) {
        errorMsg = 'This address is already registered';
      } else if (/not active|inactive/i.test(errorMsg)) {
        errorMsg = 'Referrer address is not active';
      } else if (/insufficient|balance/i.test(errorMsg)) {
        errorMsg = 'Insufficient IAM balance. Please buy more IAM tokens.';
      }
      setStatus(errorMsg, '#ff6b6b');
      registerBtn.disabled = false;
    }
  }

  (async function(){
    try{
      await connect();
      await initReferralSwap();
      await refresh();
      // Periodic refresh
      setInterval(refresh, 8000);
    } catch(e){ setStatus(e.message || String(e), '#ff6b6b'); }
  })();

  registerBtn.addEventListener('click', doRegister);

  // ----- Collapsible Section Toggle -----
  (function() {
    const toggle = document.getElementById('benefits-toggle');
    const content = document.getElementById('benefits-content');
    if (toggle && content) {
      toggle.addEventListener('click', function() {
        const isActive = toggle.classList.contains('active');
        if (isActive) {
          toggle.classList.remove('active');
          content.classList.remove('active');
        } else {
          toggle.classList.add('active');
          content.classList.add('active');
        }
      });
    }
    
    // Register Guide Toggle
    const registerToggle = document.getElementById('register-guide-toggle');
    const registerContent = document.getElementById('register-guide-content');
    if (registerToggle && registerContent) {
      registerToggle.addEventListener('click', function() {
        const isActive = registerToggle.classList.contains('active');
        if (isActive) {
          registerToggle.classList.remove('active');
          registerContent.classList.remove('active');
        } else {
          registerToggle.classList.add('active');
          registerContent.classList.add('active');
        }
      });
    }
  })();

  // ----- Multi-language Support -----
  const translations = {
    en: {
      title: '💰 IAM Token Benefits & Income Plan',
      benefitsHeading: '🎯 IAM Token Benefits:',
      benefits: [
        { label: 'Scalable Token:', text: 'IAM token is designed to increase in value as the platform grows and more users join the network' },
        { label: 'Platform Utility:', text: 'Use IAM tokens for registration, transactions, and various platform services' },
        { label: 'Network Rewards:', text: 'Earn IAM tokens through referrals and network expansion activities' },
        { label: 'Decentralized Ownership:', text: 'Full control over your tokens with blockchain transparency' },
        { label: 'Stable Ecosystem:', text: 'Backed by a structured referral system that ensures sustainable growth' }
      ],
      incomeHeading: '💵 Income Generation Plan:',
      income: [
        { label: 'Referral Commissions:', text: 'Earn rewards when new users register through your referral link' },
        { label: 'Network Building:', text: 'Build your downline network and receive passive income from your team\'s activities' },
        { label: 'Binary Structure:', text: 'Our binary system allows you to earn from both left and right legs of your network' },
        { label: 'Token Appreciation:', text: 'As the platform grows, your IAM token holdings increase in value' },
        { label: 'Multiple Revenue Streams:', text: 'Combine referral rewards, token appreciation, and network bonuses' },
        { label: 'Compounding Growth:', text: 'Reinvest your earnings to expand your network and maximize returns' }
      ],
      growthHeading: '📈 Growth Potential:',
      growth: [
        'Early adopters benefit from lower entry costs and higher earning potential',
        'The referral system creates exponential network growth opportunities',
        'Token price appreciation based on platform adoption and user base expansion',
        'Long-term wealth building through sustainable network development'
      ],
      registerGuideTitle: '📝 How to Register',
      registerStepsHeading: '📋 Registration Steps:',
      registerSteps: [
        'First, obtain DAI tokens on Polygon network. You can buy DAI from exchanges (Binance, Coinbase, etc.) and transfer to Polygon, or swap any token from your SafePal or MetaMask wallet to DAI using DEXs like QuickSwap, Uniswap V3, or SushiSwap',
        'The DAI contract address on Polygon is displayed at the top of the page - use it to add DAI token to your wallet',
        'Connect your MetaMask or SafePal wallet',
        'Use the Quick Swap feature to exchange your DAI tokens for IAM tokens',
        'If you need more IAM for registration, the required DAI amount will be automatically filled in the swap field',
        'Swap the DAI amount to IAM tokens',
        'After you have sufficient IAM tokens, the Register button will be enabled',
        'Your wallet address will be automatically filled in the "New User Address" field',
        'The referrer and upper addresses are automatically set from the referral link (or your own address for self-referral)',
        'Click the "Register" button to complete your registration',
        'Wait for the transaction confirmation on the blockchain',
        'After successful registration, you will be redirected to the home page'
      ],
      registerRequirementsHeading: '✅ Requirements:',
      registerRequirements: [
        'DAI tokens on Polygon network (you can swap any token from SafePal or MetaMask to DAI using DEXs)',
        'MetaMask or SafePal wallet installed and connected to Polygon network',
        'Sufficient DAI tokens to purchase IAM tokens for registration',
        'Polygon network (Matic) connection in your wallet',
        'Valid referral link (optional, will use self-referral if not provided)'
      ],
      registerImportantHeading: '⚠️ Important Notes:',
      registerImportant: [
        'Ownership of the created account can be transferred to others',
        'The referrer and upper addresses are set automatically from the referral link',
        'Make sure you have enough funds for both token purchase and gas fees',
        'If you are already registered, you will be redirected to the home page automatically',
        'Transactions require blockchain confirmation - please be patient',
        'Keep your private keys secure and never share them with anyone'
      ]
    },
    zh: {
      title: '💰 IAM代币优势和收入计划',
      benefitsHeading: '🎯 IAM代币优势:',
      benefits: [
        { label: '可扩展代币:', text: 'IAM代币设计为随着平台发展、更多用户加入网络而增值' },
        { label: '平台实用性:', text: '使用IAM代币进行注册、交易和各种平台服务' },
        { label: '网络奖励:', text: '通过推荐和网络扩展活动赚取IAM代币' },
        { label: '去中心化所有权:', text: '通过区块链透明度完全控制您的代币' },
        { label: '稳定生态系统:', text: '由结构化推荐系统支持，确保可持续增长' }
      ],
      incomeHeading: '💵 收入生成计划:',
      income: [
        { label: '推荐佣金:', text: '当新用户通过您的推荐链接注册时获得奖励' },
        { label: '网络建设:', text: '建立您的下线网络并从团队活动中获得被动收入' },
        { label: '二元结构:', text: '我们的二元系统允许您从网络的左右分支中赚取收益' },
        { label: '代币升值:', text: '随着平台发展，您的IAM代币持有量价值增加' },
        { label: '多重收入流:', text: '结合推荐奖励、代币升值和网络奖金' },
        { label: '复利增长:', text: '将您的收益再投资以扩展网络并最大化回报' }
      ],
      growthHeading: '📈 增长潜力:',
      growth: [
        '早期采用者受益于较低的进入成本和更高的盈利潜力',
        '推荐系统创造指数级网络增长机会',
        '基于平台采用和用户群扩展的代币价格升值',
        '通过可持续网络发展实现长期财富积累'
      ],
      registerGuideTitle: '📝 如何注册',
      registerStepsHeading: '📋 注册步骤:',
      registerSteps: [
        '首先，在Polygon网络上获取DAI代币。您可以从交易所（币安、Coinbase等）购买DAI并转移到Polygon，或使用DEX（如QuickSwap、Uniswap V3或SushiSwap）将SafePal或MetaMask钱包中的任何代币交换为DAI',
        '页面顶部显示Polygon上的DAI合约地址 - 使用它将DAI代币添加到您的钱包',
        '连接您的MetaMask或SafePal钱包',
        '使用快速交换功能将您的DAI代币兑换为IAM代币',
        '如果您需要更多IAM用于注册，所需的DAI金额将自动填充到交换字段中',
        '将DAI金额交换为IAM代币',
        '当您有足够的IAM代币后，注册按钮将被启用',
        '您的钱包地址将自动填充到"新用户地址"字段中',
        '推荐人和上级地址从推荐链接自动设置（或用于自推荐的您自己的地址）',
        '点击"注册"按钮完成注册',
        '等待区块链上的交易确认',
        '注册成功后，您将被重定向到首页'
      ],
      registerRequirementsHeading: '✅ 要求:',
      registerRequirements: [
        'Polygon网络上的DAI代币（您可以使用DEX将SafePal或MetaMask中的任何代币交换为DAI）',
        '已安装并连接到Polygon网络的MetaMask或SafePal钱包',
        '足够的DAI代币用于购买注册所需的IAM代币',
        '钱包中连接Polygon网络（Matic）',
        '有效的推荐链接（可选，如未提供将使用自推荐）'
      ],
      registerImportantHeading: '⚠️ 重要提示:',
      registerImportant: [
        '已创建账户的所有权可以转让给他人',
        '推荐人和上级地址从推荐链接自动设置',
        '确保您有足够的资金用于代币购买和gas费用',
        '如果您已经注册，将自动重定向到首页',
        '交易需要区块链确认 - 请耐心等待',
        '请妥善保管您的私钥，切勿与任何人分享'
      ]
    },
    ru: {
      title: '💰 Преимущества токена IAM и план дохода',
      benefitsHeading: '🎯 Преимущества токена IAM:',
      benefits: [
        { label: 'Масштабируемый токен:', text: 'Токен IAM разработан для увеличения стоимости по мере роста платформы и присоединения новых пользователей' },
        { label: 'Утилита платформы:', text: 'Используйте токены IAM для регистрации, транзакций и различных сервисов платформы' },
        { label: 'Сетевые награды:', text: 'Зарабатывайте токены IAM через рефералы и деятельность по расширению сети' },
        { label: 'Децентрализованное владение:', text: 'Полный контроль над вашими токенами с прозрачностью блокчейна' },
        { label: 'Стабильная экосистема:', text: 'Поддерживается структурированной реферальной системой, обеспечивающей устойчивый рост' }
      ],
      incomeHeading: '💵 План генерации дохода:',
      income: [
        { label: 'Реферальные комиссии:', text: 'Зарабатывайте награды, когда новые пользователи регистрируются по вашей реферальной ссылке' },
        { label: 'Построение сети:', text: 'Создавайте свою нисходящую сеть и получайте пассивный доход от деятельности вашей команды' },
        { label: 'Бинарная структура:', text: 'Наша бинарная система позволяет вам зарабатывать с обеих сторон вашей сети (левой и правой)' },
        { label: 'Рост стоимости токенов:', text: 'По мере роста платформы стоимость ваших токенов IAM увеличивается' },
        { label: 'Множественные источники дохода:', text: 'Комбинируйте реферальные награды, рост стоимости токенов и сетевые бонусы' },
        { label: 'Сложный рост:', text: 'Реинвестируйте свой доход для расширения сети и максимизации прибыли' }
      ],
      growthHeading: '📈 Потенциал роста:',
      growth: [
        'Ранние пользователи получают выгоду от более низких затрат на вход и более высокого потенциала заработка',
        'Реферальная система создает экспоненциальные возможности роста сети',
        'Рост цены токена на основе принятия платформы и расширения базы пользователей',
        'Долгосрочное накопление богатства через устойчивое развитие сети'
      ],
      registerGuideTitle: '📝 Как зарегистрироваться',
      registerStepsHeading: '📋 Шаги регистрации:',
      registerSteps: [
        'Сначала получите токены DAI в сети Polygon. Вы можете купить DAI на биржах (Binance, Coinbase и т.д.) и перевести в Polygon, или обменять любой токен из вашего кошелька SafePal или MetaMask на DAI, используя DEX, такие как QuickSwap, Uniswap V3 или SushiSwap',
        'Адрес контракта DAI в Polygon отображается вверху страницы - используйте его для добавления токена DAI в ваш кошелек',
        'Подключите свой кошелек MetaMask или SafePal',
        'Используйте функцию быстрого обмена для обмена ваших токенов DAI на токены IAM',
        'Если вам нужно больше IAM для регистрации, необходимая сумма DAI будет автоматически заполнена в поле обмена',
        'Обменяйте сумму DAI на токены IAM',
        'После того как у вас будет достаточно токенов IAM, кнопка "Зарегистрироваться" будет включена',
        'Адрес вашего кошелька будет автоматически заполнен в поле "Адрес нового пользователя"',
        'Адреса реферала и верхнего уровня автоматически устанавливаются из реферальной ссылки (или ваш собственный адрес для самоприглашения)',
        'Нажмите кнопку "Зарегистрироваться", чтобы завершить регистрацию',
        'Дождитесь подтверждения транзакции в блокчейне',
        'После успешной регистрации вы будете перенаправлены на домашнюю страницу'
      ],
      registerRequirementsHeading: '✅ Требования:',
      registerRequirements: [
        'Токены DAI в сети Polygon (вы можете обменять любой токен из SafePal или MetaMask на DAI, используя DEX)',
        'Установленный и подключенный к сети Polygon кошелек MetaMask или SafePal',
        'Достаточно токенов DAI для покупки токенов IAM для регистрации',
        'Подключение к сети Polygon (Matic) в вашем кошельке',
        'Действительная реферальная ссылка (необязательно, будет использоваться самоприглашение, если не предоставлена)'
      ],
      registerImportantHeading: '⚠️ Важные примечания:',
      registerImportant: [
        'Владение созданным аккаунтом можно передать другому лицу',
        'Адреса реферала и верхнего уровня устанавливаются автоматически из реферальной ссылки',
        'Убедитесь, что у вас достаточно средств как для покупки токенов, так и для комиссий за газ',
        'Если вы уже зарегистрированы, вы будете автоматически перенаправлены на домашнюю страницу',
        'Транзакции требуют подтверждения в блокчейне - пожалуйста, будьте терпеливы',
        'Храните свои приватные ключи в безопасности и никогда не делитесь ими ни с кем'
      ]
    },
    ar: {
      title: '💰 فوائد رمز IAM وخطة الدخل',
      benefitsHeading: '🎯 فوائد رمز IAM:',
      benefits: [
        { label: 'رمز قابل للتوسع:', text: 'تم تصميم رمز IAM لزيادة قيمته مع نمو المنصة وانضمام المزيد من المستخدمين إلى الشبكة' },
        { label: 'منفعة المنصة:', text: 'استخدم رموز IAM للتسجيل والمعاملات وخدمات المنصة المختلفة' },
        { label: 'مكافآت الشبكة:', text: 'اكسب رموز IAM من خلال الإحالات وأنشطة توسيع الشبكة' },
        { label: 'الملكية اللا مركزية:', text: 'تحكم كامل في رموزك مع شفافية البلوك تشين' },
        { label: 'نظام بيئي مستقر:', text: 'مدعوم بنظام إحالة منظم يضمن النمو المستدام' }
      ],
      incomeHeading: '💵 خطة توليد الدخل:',
      income: [
        { label: 'عمولات الإحالة:', text: 'اكسب المكافآت عند تسجيل مستخدمين جدد من خلال رابط الإحالة الخاص بك' },
        { label: 'بناء الشبكة:', text: 'قم ببناء شبكة خطك الهابط واحصل على دخل سلبي من أنشطة فريقك' },
        { label: 'الهيكل الثنائي:', text: 'يسمح نظامنا الثنائي لك بالربح من كلا جانبي شبكتك (الأيمن والأيسر)' },
        { label: 'تقدير قيمة الرمز:', text: 'مع نمو المنصة، تزداد قيمة حيازات رمز IAM الخاص بك' },
        { label: 'تدفقات دخل متعددة:', text: 'اجمع بين مكافآت الإحالة وتقدير قيمة الرمز ومكافآت الشبكة' },
        { label: 'النمو المركب:', text: 'أعد استثمار أرباحك لتوسيع شبكتك وتعظيم العوائد' }
      ],
      growthHeading: '📈 إمكانيات النمو:',
      growth: [
        'يستفيد المستخدمون الأوائل من تكاليف دخول أقل وإمكانيات ربح أعلى',
        'ينشئ نظام الإحالة فرص نمو شبكي أسية',
        'تقدير سعر الرمز بناءً على اعتماد المنصة وتوسع قاعدة المستخدمين',
        'بناء الثروة على المدى الطويل من خلال تطوير الشبكة المستدام'
      ],
      registerGuideTitle: '📝 كيفية التسجيل',
      registerStepsHeading: '📋 خطوات التسجيل:',
      registerSteps: [
        'أولاً، احصل على رموز DAI على شبكة Polygon. يمكنك شراء DAI من البورصات (Binance، Coinbase، إلخ) ونقلها إلى Polygon، أو تبديل أي رمز من محفظة SafePal أو MetaMask الخاصة بك إلى DAI باستخدام DEX مثل QuickSwap أو Uniswap V3 أو SushiSwap',
        'عنوان عقد DAI على Polygon معروض في أعلى الصفحة - استخدمه لإضافة رمز DAI إلى محفظتك',
        'قم بتوصيل محفظة MetaMask أو SafePal الخاصة بك',
        'استخدم ميزة التبادل السريع لتبديل رموز DAI الخاصة بك برموز IAM',
        'إذا كنت بحاجة إلى المزيد من IAM للتسجيل، سيتم ملء مبلغ DAI المطلوب تلقائياً في حقل التبادل',
        'قم بتبديل مبلغ DAI برموز IAM',
        'بعد أن يكون لديك رموز IAM كافية، سيتم تفعيل زر "التسجيل"',
        'سيتم ملء عنوان محفظتك تلقائياً في حقل "عنوان المستخدم الجديد"',
        'يتم تعيين عناوين المُحيل والأعلى تلقائياً من رابط الإحالة (أو عنوانك الخاص للإحالة الذاتية)',
        'انقر على زر "التسجيل" لإكمال تسجيلك',
        'انتظر تأكيد المعاملة على البلوك تشين',
        'بعد التسجيل الناجح، سيتم إعادة توجيهك إلى الصفحة الرئيسية'
      ],
      registerRequirementsHeading: '✅ المتطلبات:',
      registerRequirements: [
        'رموز DAI على شبكة Polygon (يمكنك تبديل أي رمز من SafePal أو MetaMask إلى DAI باستخدام DEX)',
        'محفظة MetaMask أو SafePal مثبتة ومتصلة بشبكة Polygon',
        'رموز DAI كافية لشراء رموز IAM للتسجيل',
        'اتصال بشبكة Polygon (Matic) في محفظتك',
        'رابط إحالة صالح (اختياري، سيتم استخدام الإحالة الذاتية إذا لم يتم توفيره)'
      ],
      registerImportantHeading: '⚠️ ملاحظات مهمة:',
      registerImportant: [
        'يمكن نقل ملكية الحساب المُنشأ إلى شخص آخر',
        'يتم تعيين عناوين المُحيل والأعلى تلقائياً من رابط الإحالة',
        'تأكد من أن لديك أموال كافية لشراء الرمز ورسوم الغاز',
        'إذا كنت مسجلاً بالفعل، سيتم إعادة توجيهك تلقائياً إلى الصفحة الرئيسية',
        'تتطلب المعاملات تأكيد البلوك تشين - يرجى التحلي بالصبر',
        'احتفظ بمفاتيحك الخاصة بأمان ولا تشاركها مع أي شخص'
      ]
    },
    fa: {
      title: '💰 IAM Token Benefits & Income Plan',
      benefitsHeading: '🎯 مزایای توکن IAM:',
      benefits: [
        { label: 'توکن مقیاس‌پذیر:', text: 'توکن IAM به گونه‌ای طراحی شده که با رشد پلتفرم و ورود کاربران بیشتر به شبکه ارزش آن افزایش یابد' },
        { label: 'قابلیت استفاده در پلتفرم:', text: 'از توکن‌های IAM برای ثبت‌نام، تراکنش‌ها و خدمات مختلف پلتفرم استفاده کنید' },
        { label: 'پاداش‌های شبکه:', text: 'از طریق معرفی و فعالیت‌های گسترش شبکه توکن IAM کسب کنید' },
        { label: 'مالکیت غیرمتمرکز:', text: 'کنترل کامل بر توکن‌های خود با شفافیت بلاک‌چین' },
        { label: 'اکوسیستم پایدار:', text: 'پشتیبانی شده توسط سیستم معرفی ساختاریافته که رشد پایدار را تضمین می‌کند' }
      ],
      incomeHeading: '💵 پلن درآمدزایی:',
      income: [
        { label: 'کمیسیون‌های معرفی:', text: 'زمانی که کاربران جدید از طریق لینک معرفی شما ثبت‌نام می‌کنند پاداش دریافت کنید' },
        { label: 'ساخت شبکه:', text: 'شبکه زیرمجموعه خود را بسازید و از فعالیت‌های تیم خود درآمد passively دریافت کنید' },
        { label: 'ساختار باینری:', text: 'سیستم باینری ما به شما امکان می‌دهد از هر دو شاخه چپ و راست شبکه خود درآمد کسب کنید' },
        { label: 'افزایش ارزش توکن:', text: 'با رشد پلتفرم، دارایی توکن IAM شما افزایش ارزش پیدا می‌کند' },
        { label: 'جریان‌های درآمدی متعدد:', text: 'پاداش‌های معرفی، افزایش ارزش توکن و پاداش‌های شبکه را ترکیب کنید' },
        { label: 'رشد مرکب:', text: 'درآمد خود را مجدداً سرمایه‌گذاری کنید تا شبکه خود را گسترش دهید و بازدهی را به حداکثر برسانید' }
      ],
      growthHeading: '📈 پتانسیل رشد:',
      growth: [
        'کاربران اولیه از هزینه ورود پایین‌تر و پتانسیل درآمدزایی بالاتر بهره‌مند می‌شوند',
        'سیستم معرفی فرصت‌های رشد نمایی شبکه را ایجاد می‌کند',
        'افزایش قیمت توکن بر اساس پذیرش پلتفرم و گسترش پایه کاربری',
        'ساخت ثروت بلندمدت از طریق توسعه پایدار شبکه'
      ],
      registerGuideTitle: '📝 How to Register',
      registerStepsHeading: '📋 مراحل ثبت‌نام:',
      registerSteps: [
        'ابتدا توکن‌های DAI را در شبکه Polygon تامین کنید. می‌توانید DAI را از صرافی‌ها (Binance، Coinbase و غیره) خریداری کرده و به Polygon منتقل کنید، یا هر توکنی که در کیف پول SafePal یا MetaMask خود دارید را با استفاده از DEXهای مانند QuickSwap، Uniswap V3 یا SushiSwap به DAI تبدیل کنید',
        'آدرس کنترکت DAI در Polygon در بالای صفحه نمایش داده می‌شود - از آن برای افزودن توکن DAI به کیف پول خود استفاده کنید',
        'کیف پول MetaMask یا SafePal خود را متصل کنید',
        'از ویژگی تبادل سریع برای تبدیل توکن‌های DAI خود به توکن‌های IAM استفاده کنید',
        'اگر نیاز به IAM بیشتر برای ثبت‌نام دارید، مقدار DAI مورد نیاز به طور خودکار در فیلد تبادل پر می‌شود',
        'مقدار DAI را به توکن‌های IAM تبدیل کنید',
        'پس از داشتن توکن‌های IAM کافی، دکمه "ثبت‌نام" فعال می‌شود',
        'آدرس کیف پول شما به طور خودکار در فیلد "آدرس کاربر جدید" پر می‌شود',
        'آدرس‌های معرف و بالادست به طور خودکار از لینک معرفی تنظیم می‌شوند (یا آدرس خودتان برای خود-معرفی)',
        'برای تکمیل ثبت‌نام روی دکمه "ثبت‌نام" کلیک کنید',
        'منتظر تأیید تراکنش در بلاک‌چین باشید',
        'پس از ثبت‌نام موفق، به صفحه اصلی هدایت می‌شوید'
      ],
      registerRequirementsHeading: '✅ نیازمندی‌ها:',
      registerRequirements: [
        'توکن‌های DAI در شبکه Polygon (می‌توانید هر توکنی از SafePal یا MetaMask را با استفاده از DEXها به DAI تبدیل کنید)',
        'کیف پول MetaMask یا SafePal نصب شده و متصل به شبکه Polygon',
        'توکن‌های DAI کافی برای خرید توکن‌های IAM مورد نیاز برای ثبت‌نام',
        'اتصال به شبکه Polygon (Matic) در کیف پول شما',
        'لینک معرفی معتبر (اختیاری، در صورت عدم ارائه از خود-معرفی استفاده می‌شود)'
      ],
      registerImportantHeading: '⚠️ نکات مهم:',
      registerImportant: [
        'مالکیت حساب ساخته شده قابل انتقال به غیر است',
        'آدرس‌های معرف و بالادست به طور خودکار از لینک معرفی تنظیم می‌شوند',
        'اطمینان حاصل کنید که بودجه کافی هم برای خرید توکن و هم برای کارمزد تراکنش دارید',
        'اگر قبلاً ثبت‌نام کرده‌اید، به طور خودکار به صفحه اصلی هدایت می‌شوید',
        'تراکنش‌ها نیاز به تأیید بلاک‌چین دارند - لطفاً صبور باشید',
        'کلیدهای خصوصی خود را امن نگه دارید و هرگز با کسی به اشتراک نگذارید'
      ]
    }
  };

  function renderContent(lang) {
    const t = translations[lang];
    if (!t) return;

    // Update title
    const titleEl = document.getElementById('benefits-title');
    if (titleEl) titleEl.textContent = t.title;

    // Update headings
    const benefitsHeading = document.getElementById('benefits-heading');
    const incomeHeading = document.getElementById('income-heading');
    const growthHeading = document.getElementById('growth-heading');
    if (benefitsHeading) benefitsHeading.textContent = t.benefitsHeading;
    if (incomeHeading) incomeHeading.textContent = t.incomeHeading;
    if (growthHeading) growthHeading.textContent = t.growthHeading;

    // Update benefits list
    const benefitsList = document.getElementById('benefits-list');
    if (benefitsList) {
      benefitsList.innerHTML = t.benefits.map(item => 
        `<li><strong>${item.label}</strong> ${item.text}</li>`
      ).join('');
    }

    // Update income list
    const incomeList = document.getElementById('income-list');
    if (incomeList) {
      incomeList.innerHTML = t.income.map(item => 
        `<li><strong>${item.label}</strong> ${item.text}</li>`
      ).join('');
    }

    // Update growth list
    const growthList = document.getElementById('growth-list');
    if (growthList) {
      growthList.innerHTML = t.growth.map(item => `<li>${item}</li>`).join('');
    }
  }

  function setLanguage(lang) {
    // Update active button
    document.querySelectorAll('.language-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-lang') === lang) {
        btn.classList.add('active');
      }
    });

    // Apply RTL for Persian (fa) and Arabic (ar)
    const isRTL = lang === 'fa' || lang === 'ar';
    const bodyEl = document.querySelector('.collapsible-body');
    const titleEl = document.getElementById('benefits-title');
    const toggleEl = document.getElementById('benefits-toggle');
    
    if (bodyEl) {
      if (isRTL) {
        bodyEl.classList.add('rtl');
      } else {
        bodyEl.classList.remove('rtl');
      }
    }
    
    if (titleEl) {
      if (isRTL) {
        titleEl.classList.add('rtl');
      } else {
        titleEl.classList.remove('rtl');
      }
    }
    
    if (toggleEl) {
      if (isRTL) {
        toggleEl.classList.add('rtl');
      } else {
        toggleEl.classList.remove('rtl');
      }
    }

    // Render content
    renderContent(lang);

    // Save to localStorage
    localStorage.setItem('iam-language', lang);
  }

  // Initialize language system
  (function() {
    // Load saved language or default to English
    const savedLang = localStorage.getItem('iam-language') || 'en';
    setLanguage(savedLang);

    // Add click handlers to language buttons
    document.querySelectorAll('.language-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const lang = this.getAttribute('data-lang');
        setLanguage(lang);
      });
    });
  })();

  // ----- Register Guide Multi-language Support -----
  function renderRegisterContent(lang) {
    const t = translations[lang];
    if (!t) return;

    // Update title
    const titleEl = document.getElementById('register-guide-title');
    if (titleEl) titleEl.textContent = t.registerGuideTitle;

    // Update headings
    const stepsHeading = document.getElementById('register-guide-heading');
    const requirementsHeading = document.getElementById('register-requirements-heading');
    const importantHeading = document.getElementById('register-important-heading');
    if (stepsHeading) stepsHeading.textContent = t.registerStepsHeading;
    if (requirementsHeading) requirementsHeading.textContent = t.registerRequirementsHeading;
    if (importantHeading) importantHeading.textContent = t.registerImportantHeading;

    // Update steps list (ordered)
    const stepsList = document.getElementById('register-steps-list');
    if (stepsList) {
      stepsList.innerHTML = t.registerSteps.map((item, index) => 
        `<li>${item}</li>`
      ).join('');
    }

    // Update requirements list
    const requirementsList = document.getElementById('register-requirements-list');
    if (requirementsList) {
      requirementsList.innerHTML = t.registerRequirements.map(item => 
        `<li>${item}</li>`
      ).join('');
    }

    // Update important list
    const importantList = document.getElementById('register-important-list');
    if (importantList) {
      importantList.innerHTML = t.registerImportant.map(item => 
        `<li>${item}</li>`
      ).join('');
    }
  }

  function setRegisterLanguage(lang) {
    // Update active button
    document.querySelectorAll('.language-btn-register').forEach(btn => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-lang') === lang) {
        btn.classList.add('active');
      }
    });

    // Apply RTL for Persian (fa) and Arabic (ar)
    const isRTL = lang === 'fa' || lang === 'ar';
    const bodyEl = document.getElementById('register-guide-body');
    const titleEl = document.getElementById('register-guide-title');
    const toggleEl = document.getElementById('register-guide-toggle');
    
    if (bodyEl) {
      if (isRTL) {
        bodyEl.classList.add('rtl');
      } else {
        bodyEl.classList.remove('rtl');
      }
    }
    
    if (titleEl) {
      if (isRTL) {
        titleEl.classList.add('rtl');
      } else {
        titleEl.classList.remove('rtl');
      }
    }
    
    if (toggleEl) {
      if (isRTL) {
        toggleEl.classList.add('rtl');
      } else {
        toggleEl.classList.remove('rtl');
      }
    }

    // Render content
    renderRegisterContent(lang);

    // Save to localStorage (separate key for register guide)
    localStorage.setItem('iam-register-language', lang);
  }

  // Initialize register guide language system
  (function() {
    // Load saved language or default to English
    const savedLang = localStorage.getItem('iam-register-language') || 'en';
    setRegisterLanguage(savedLang);

    // Add click handlers to register language buttons
    document.querySelectorAll('.language-btn-register').forEach(btn => {
      btn.addEventListener('click', function() {
        const lang = this.getAttribute('data-lang');
        setRegisterLanguage(lang);
      });
    });
  })();

  // ----- Quick Swap: DAI -> IAM (mirrors register.html behavior) -----
  let tokenPrice = null;
  let daiContract = null;
  async function initReferralSwap(){
    try {
      if (!provider || !signer) return;
      // Price
      if (contract && typeof contract.getTokenPrice === 'function') {
        const p = await contract.getTokenPrice();
        tokenPrice = parseFloat(ethers.formatUnits(p, 18));
      }
      // DAI contract
      const DAI_ABI = [
        "function balanceOf(address) view returns (uint256)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function allowance(address owner, address spender) view returns (uint256)"
      ];
      daiContract = new ethers.Contract(DAI_ADDRESS, DAI_ABI, signer);
      await updateReferralDaiBalance();
      wireReferralSwap();
    } catch(e){ console.error('Swap init error:', e); }
  }

  async function updateReferralDaiBalance(){
    try {
      const el = document.getElementById('quick-swap-dai-balance');
      if (!el || !daiContract || !me) return;
      const bal = await daiContract.balanceOf(me);
      const num = parseFloat(ethers.formatUnits(bal, 18));
      el.textContent = num.toFixed(2) + ' DAI';
    } catch(e){ console.warn('DAI balance failed', e); }
  }

  function referralEstimateIamFromDai(d){
    if (!d || d <= 0 || !tokenPrice || tokenPrice <= 0) return '0.00';
    return (d / tokenPrice).toFixed(6);
  }

  async function autoFillQuickSwapDai(){
    try {
      const input = document.getElementById('quick-swap-dai-amount');
      if (!input) return;
      // compute need with 20% buffer
      if (!(requiredIam > 0)) return;
      const needIam = Math.max(0, requiredIam - myIam);
      if (needIam <= 0) { input.value = ''; return; }
      // fetch price if missing
      if (!tokenPrice && contract && contract.getTokenPrice){
        const p = await contract.getTokenPrice();
        tokenPrice = parseFloat(ethers.formatUnits(p, 18));
      }
      let needDai = needIam * (tokenPrice || 1);
      needDai = Math.ceil(needDai * 1.20 * 10000) / 10000; // +20%
      input.value = needDai.toFixed(4);
      try { input.dispatchEvent(new Event('input', { bubbles:true })); } catch(_){ }
    } catch(_){ }
  }

  function wireReferralSwap(){
    const daiInput = document.getElementById('quick-swap-dai-amount');
    const statusEl2 = document.getElementById('quick-swap-status');
    const swapBtn = document.getElementById('quick-swap-btn');
    daiInput?.addEventListener('input', function(){
      // no live estimate label in UI here; keep behavior minimal
    });
    swapBtn?.addEventListener('click', async function(){
      try {
        const amount = parseFloat(daiInput.value) || 0;
        if (amount <= 0) { statusEl2.textContent = 'Please enter a valid DAI amount'; statusEl2.style.color = '#e74c3c'; return; }
        if (!daiContract) await initReferralSwap();
        // allowance check
        const amountWei = ethers.parseUnits(amount.toString(), 18);
        const allowance = await daiContract.allowance(me, IAM_ADDRESS);
        const needsApproval = (typeof allowance.lt === 'function') ? allowance.lt(amountWei) : (BigInt(allowance) < BigInt(amountWei));
        if (needsApproval){
          statusEl2.textContent = 'Approving DAI...'; statusEl2.style.color = '#5da0ff';
          const maxUint = ethers.MaxUint256 || ethers.constants?.MaxUint256;
          const ap = await daiContract.approve(IAM_ADDRESS, maxUint);
          await ap.wait();
        }
        statusEl2.textContent = 'Executing swap...'; statusEl2.style.color = '#5da0ff';
        const tx = await contract.buyTokens ? contract.buyTokens(amountWei) : contract.registerAndActivate; // fallback guard
        if (!tx || !tx.wait){
          // If buyTokens not available, show message
          statusEl2.textContent = 'Direct buy not supported by contract'; statusEl2.style.color = '#e74c3c'; return;
        }
        await tx.wait();
        statusEl2.textContent = '✅ Swap successful'; statusEl2.style.color = '#00ff88';
        await refresh();
        await updateReferralDaiBalance();
        daiInput.value = '';
      } catch(e){
        let msg = (e && e.message) ? e.message : String(e);
        if (/denied|reject/i.test(msg)) msg = 'Transaction cancelled by user';
        statusEl2.textContent = 'Swap failed: ' + msg; statusEl2.style.color = '#e74c3c';
      }
    });
  }
  </script>
</body>
</html>


