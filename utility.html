<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Utility Tools | PHOENIX (IAM)</title>
  <script>window.SKIP_META = true;</script>
  <script>
    // Suppress noisy extension/MetaMask RPC messages that don't affect functionality
    window.addEventListener('error', function(e){
      const m = (e && e.message) || '';
      if (m.includes('Could not establish connection') || m.includes('getEnabledChains') || m.includes('isDefaultWallet') || m.includes('Internal JSON-RPC error')) {
        e.preventDefault();
        return false;
      }
    });
    window.addEventListener('unhandledrejection', function(e){
      const r = e && e.reason;
      const msg = (r && (r.message || r)) || '';
      if (typeof msg === 'string' && (msg.includes('Could not establish connection') || msg.includes('getEnabledChains') || msg.includes('isDefaultWallet') || msg.includes('Internal JSON-RPC error'))) {
        e.preventDefault();
        return false;
      }
    });
  </script>
  
  <!-- Load ethers.js version 6 from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.1/dist/ethers.umd.min.js"></script>
  
  <!-- Main scripts for wallet connection -->
  <script src="js/config.js"></script>
  <script src="js/auto-wallet-connect.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #2d3748 100%);
      color: #e2e8f0;
      font-family: 'Noto Sans Arabic', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .back-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: linear-gradient(135deg, #a786ff, #00ff88);
      color: #181c2a;
      text-decoration: none;
      padding: 0.7rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(167, 134, 255, 0.3);
      transition: all 0.3s ease;
    }
    
    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(167, 134, 255, 0.3);
    }
    
    .utility-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .utility-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .utility-card {
      background: linear-gradient(135deg, rgba(35,41,70,0.8) 0%, rgba(45,55,72,0.8) 100%);
      border: 1px solid rgba(0,255,136,0.2);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 16px rgba(0,255,136,0.1);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    .utility-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0,255,136,0.2);
      border-color: rgba(0,255,136,0.4);
    }
    
    .utility-card h3 {
      font-size: 1.3rem;
      margin: 0 0 0.8rem 0;
      color: #00ff88;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .utility-card .icon {
      font-size: 1.5rem;
    }
    
    .utility-btn {
      background: linear-gradient(45deg, #00ff88, #00cc6a);
      color: #1a202c;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      flex: 1;
    }
    
    .utility-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,255,136,0.3);
    }
    
    .utility-btn.secondary {
      background: linear-gradient(45deg, #a786ff, #8b5cf6);
      color: white;
    }
    
    .calculator-section {
      background: rgba(0,255,136,0.05);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid rgba(0,255,136,0.1);
    }
    
    .calculator-input {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid rgba(0,255,136,0.3);
      border-radius: 8px;
      background: rgba(26,32,44,0.8);
      color: #e2e8f0;
      font-size: 1rem;
      margin-bottom: 1rem;
      box-sizing: border-box;
    }
    
    .calculator-input:focus {
      outline: none;
      border-color: #00ff88;
      box-shadow: 0 0 0 3px rgba(0,255,136,0.1);
    }
    
    .calculator-result {
      background: rgba(0,255,136,0.1);
      border: 1px solid rgba(0,255,136,0.2);
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      color: #e2e8f0;
      font-family: 'Fira Mono', monospace;
      word-break: break-all;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-left: 0.5rem;
    }
    
    .status-online {
      background: #00ff88;
      box-shadow: 0 0 10px rgba(0,255,136,0.5);
    }
    
    .status-offline {
      background: #ff4757;
      box-shadow: 0 0 10px rgba(255,71,87,0.5);
    }
    
    @media (max-width: 768px) {
      .utility-grid {
        grid-template-columns: 1fr;
      }
      
      .utility-actions {
        flex-direction: column;
      }
      
      .utility-header h1 {
        font-size: 2rem;
      }
    }
    
    /* Animation keyframes */
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    /* Back Button */
    .back-btn {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: linear-gradient(135deg, #a786ff, #00ff88);
      color: #0a0f1c;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.9rem;
      z-index: 1000;
    }
    
    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(167, 134, 255, 0.3);
    }
    
  </style>
</head>
<body>
    
    <!-- Back Button -->
    <a href="index.html" class="back-btn">← Back</a>

    <div class="utility-grid">      <!-- Address and Number Conversion -->
       <div class="utility-card">
         <h3><span class="icon">🔄</span>Address and Number Conversion</h3>
         <div class="calculator-section">
           <div style="margin-bottom: 1rem;">
             <h5 style="color: #a786ff; margin-bottom: 0.5rem;">📊 Number to Address</h5>
             <input type="number" class="calculator-input" id="index-input" placeholder="User number (num)" min="1">
             <button class="utility-btn" onclick="convertNumberToAddress()" style="width: 100%;">Convert</button>
             <div class="calculator-result" id="index-result" style="display: none;"></div>
           </div>
           <div>
             <h5 style="color: #a786ff; margin-bottom: 0.5rem;">👤 Address to Number</h5>
             <input type="text" class="calculator-input" id="address-input" placeholder="Wallet address (0x...)" style="direction: ltr;">
             <button class="utility-btn" onclick="convertAddressToNumber()" style="width: 100%;">Convert</button>
             <div class="calculator-result" id="address-result" style="display: none;"></div>
           </div>
         </div>
       </div>

       <!-- Single User Lookup -->
       <div class="utility-card">
         <h3><span class="icon">👤</span>Single User Lookup</h3>
         <div class="calculator-section">
           <div style="margin-bottom: 1rem;">
             <h5 style="color: #a786ff; margin-bottom: 0.5rem;">📊 Enter User Number</h5>
             <input type="number" class="calculator-input" id="user-index-input" placeholder="Enter user number (num)" min="1">
             <button class="utility-btn" onclick="showSingleUser()" style="width: 100%;">Show User Info</button>
             <div class="calculator-result" id="user-result" style="display: none;"></div>
           </div>
         </div>
       </div>

      <!-- IAM ↔ DAI Converter (on-chain estimate) -->
      <div class="utility-card" dir="ltr">
        <h3><span class="icon">💱</span>IAM ↔ DAI Converter (on-chain estimate)</h3>
        <div class="calculator-section">
          <div style="display:flex; flex-direction:column; gap:.75rem;">
            <div style="flex:1; min-width:220px;">
              <label for="conv-iam" style="color:#a0aec0; font-size:.9rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                <span>IAM</span>
                <button id="conv-iam-max" type="button" class="utility-btn" style="padding:.25rem .6rem; border-radius:6px; font-size:.8rem; line-height:1; background:linear-gradient(45deg,#334155,#1f2937); color:#e2e8f0;">Max</button>
              </label>
              <input id="conv-iam" type="number" inputmode="decimal" class="calculator-input" placeholder="Enter IAM amount" min="0" step="0.000000000000000001" style="direction:ltr; text-align:left;">
            </div>
            <div style="flex:1; min-width:220px;">
              <label for="conv-dai" style="color:#a0aec0; font-size:.9rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem;">
                <span>DAI</span>
                <button id="conv-dai-max" type="button" class="utility-btn" style="padding:.25rem .6rem; border-radius:6px; font-size:.8rem; line-height:1; background:linear-gradient(45deg,#334155,#1f2937); color:#e2e8f0;">Max</button>
              </label>
              <input id="conv-dai" type="number" inputmode="decimal" class="calculator-input" placeholder="Enter DAI amount" min="0" step="0.000000000000000001" style="direction:ltr; text-align:left;">
            </div>
          </div>
          <div class="calculator-result" id="conv-result" style="display:none; text-align:left;"></div>
          <small style="color:#a0aec0; display:block; margin-top:.5rem;">
            Uses contract estimateBuy/estimateSell for accuracy. Connect wallet if required.
          </small>
        </div>
      </div>

      <!-- Voting System for Numbers -->
      <div class="utility-card" dir="ltr">
        <h3><span class="icon">🗳️</span>Vote by Number</h3>
        <div class="calculator-section">
          <div style="display:flex; flex-direction:column; gap:.75rem; align-items:stretch;">
            <div style="flex:1; min-width:220px;">
              <label for="vote-index-input" style="color:#a0aec0; font-size:.9rem;">User Number (num)</label>
              <input id="vote-index-input" type="number" inputmode="numeric" class="calculator-input" placeholder="e.g. 123" min="1" step="1" style="direction:ltr; text-align:left;">
            </div>
            <div style="display:flex; flex-direction:column; gap:.5rem; width:100%;">
              <button class="utility-btn" onclick="window.voteForIndex(true)">👍 Like</button>
              <button class="utility-btn secondary" onclick="window.voteForIndex(false)">👎 Dislike</button>
            </div>
          </div>
          <div class="calculator-result" id="vote-result" style="display:none; text-align:right;"></div>
          <small style="color:#a0aec0; display:block; margin-top:.5rem;">Connect your wallet to vote. You cannot vote for yourself.</small>
        </div>
      </div>

      <!-- Voting System by Address -->
      <div class="utility-card" dir="ltr">
        <h3><span class="icon">🗳️</span>Vote by Address</h3>
        <div class="calculator-section">
          <div style="display:flex; flex-direction:column; gap:.75rem; align-items:stretch;">
            <div style="flex:1; min-width:260px;">
              <label for="vote-address-input" style="color:#a0aec0; font-size:.9rem;">User Address (0x...)</label>
              <input id="vote-address-input" type="text" class="calculator-input" placeholder="0x..." style="direction:ltr; text-align:left;">
            </div>
            <div style="display:flex; flex-direction:column; gap:.5rem; width:100%;">
              <button class="utility-btn" onclick="window.voteFromAddressCard(true)">👍 Like</button>
              <button class="utility-btn secondary" onclick="window.voteFromAddressCard(false)">👎 Dislike</button>
            </div>
          </div>
          <div class="calculator-result" id="vote-address-result" style="display:none; text-align:right;"></div>
          <small style="color:#a0aec0; display:block; margin-top:.5rem;">Address must be valid and wallet connected.</small>
        </div>
      </div>

      <!-- Vote Status Viewer -->
      <div class="utility-card" dir="ltr">
        <h3><span class="icon">📊</span>User Vote Status</h3>
        <div class="calculator-section">
          <div style="display:flex; flex-direction:column; gap:.75rem; align-items:stretch;">
            <div style="flex:1; min-width:260px;">
              <label for="vote-status-input" style="color:#a0aec0; font-size:.9rem;">Number (num) or Address</label>
              <input id="vote-status-input" type="text" class="calculator-input" placeholder="e.g. 123 or 0x..." style="direction:ltr; text-align:left;">
            </div>
            <div style="width:100%;">
              <button class="utility-btn" style="width:100%;" onclick="window.showVoteStatus()">Show Status</button>
            </div>
          </div>
          <div class="calculator-result" id="vote-status-result" style="display:none; text-align:right;"></div>
          <small style="color:#a0aec0; display:block; margin-top:.5rem;">Displays likes, dislikes, your vote, and net score.</small>
        </div>
      </div>


    </div>



  <script>
    // Contract address - using new contract by default
    const UTILITY_IAM_ADDRESS = '0xa4C37107AbaeD664978e5f6db79249Ad08Fe0dBf'; // New contract
    
    // Set global contract address if not already set
    if (!window.IAM_ADDRESS) {
        window.IAM_ADDRESS = UTILITY_IAM_ADDRESS;
    }

    // Show status message
    function showStatus(message, type = 'info') {
        // Create a temporary status message
        const statusEl = document.createElement('div');
        statusEl.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'success' ? 'rgba(0, 255, 136, 0.9)' : type === 'error' ? 'rgba(255, 68, 68, 0.9)' : 'rgba(167, 134, 255, 0.9)'};
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            font-size: 13px;
            max-width: 300px;
            backdrop-filter: blur(8px);
            border: 1px solid ${type === 'success' ? 'rgba(0, 255, 136, 0.3)' : type === 'error' ? 'rgba(255, 68, 68, 0.3)' : 'rgba(167, 134, 255, 0.3)'};
            animation: slideIn 0.3s ease;
        `;
        
        const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
        statusEl.innerHTML = `${icon} ${message}`;
        
        document.body.appendChild(statusEl);
        
        setTimeout(() => {
            if (statusEl.parentElement) {
                statusEl.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => statusEl.remove(), 300);
            }
        }, 3000);
    }

    // Convert number to address (using getAddressByNumber)
    window.convertNumberToAddress = async function() {
       const num = parseInt(document.getElementById('index-input').value);
       
       if (!num || num < 1) {
         showStatus('Please enter a valid number (minimum 1)', 'error');
         return;
       }
       
       const resultDiv = document.getElementById('index-result');
       resultDiv.innerHTML = 'Converting...';
       resultDiv.style.display = 'block';
       
       try {
         // Use shared wallet connection
         if (!window.connectWallet) {
           throw new Error('Wallet connection not available');
         }
         
         const connection = await window.connectWallet();
         if (!connection || !connection.contract) {
           throw new Error('Contract connection failed');
         }
         
         const { contract } = connection;
         console.log(`🔄 Converting number ${num} to address...`);
         
         // Use getAddressByNumber from new contract
         let address;
         try {
           address = await contract.getAddressByNumber(num);
           console.log(`✅ Got address from getAddressByNumber: ${address}`);
         } catch (error) {
           console.log(`❌ getAddressByNumber failed: ${error.message}`);
           
           // Check if the number is within reasonable bounds
           try {
             const totalUsers = await contract.wallets();
             console.log(`📊 Total users in system: ${totalUsers}`);
             
             if (num > Number(totalUsers)) {
               throw new Error(`Number ${num} is greater than total users (${totalUsers})`);
             }
             
             throw new Error(`Cannot convert number ${num} to address. The number might not exist.`);
           } catch (fallbackError) {
             console.log(`❌ Conversion failed: ${fallbackError.message}`);
             throw new Error(`Number to address conversion failed: ${fallbackError.message}`);
           }
         }
         
         if (!address || address === '0x0000000000000000000000000000000000000000') {
           resultDiv.innerHTML = `
             <strong>Result:</strong><br>
             Number: ${num}<br>
             <span style="color: #ffa502;">No user found at this number</span>
           `;
         } else {
           resultDiv.innerHTML = `
             <strong>Result:</strong><br>
             Number: ${num}<br>
             Address: ${address}<br>
             <button onclick="copyToClipboard('${address}')" style="background: #00ff88; color: #1a202c; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-top: 0.5rem;">Copy Address</button>
           `;
         }
       } catch (error) {
         console.error('❌ Number to address conversion error:', error);
         resultDiv.innerHTML = `
           <strong>Error:</strong><br>
           ${error.message}<br>
           <small style="color: #a0aec0;">Please check if the number exists and try again</small>
         `;
       }
     }

    // Convert address to number (using getUserNumber)
    window.convertAddressToNumber = async function() {
       const address = document.getElementById('address-input').value.trim();
       
       if (!address || !address.startsWith('0x')) {
         showStatus('Please enter a valid address', 'error');
         return;
       }
       
       const resultDiv = document.getElementById('address-result');
       resultDiv.innerHTML = 'Converting...';
       resultDiv.style.display = 'block';
       
       try {
         // Use shared wallet connection
         if (!window.connectWallet) {
           throw new Error('Wallet connection not available');
         }
         
         const connection = await window.connectWallet();
         if (!connection || !connection.contract) {
           throw new Error('Contract connection failed');
         }
         
         const { contract } = connection;
         
         // Use getUserNumber from new contract
         const num = await contract.getUserNumber(address);
         
         if (num && num > 0) {
           resultDiv.innerHTML = `
             <strong>Result:</strong><br>
             Address: ${address}<br>
             Number: ${num.toString()}<br>
             <button onclick="copyToClipboard('${num.toString()}')" style="background: #00ff88; color: #1a202c; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; margin-top: 0.5rem;">Copy Number</button>
           `;
         } else {
           resultDiv.innerHTML = `
             <strong>Result:</strong><br>
             Address: ${address}<br>
             <span style="color: #ffa502;">This address is not registered in the system</span>
           `;
         }
       } catch (error) {
         resultDiv.innerHTML = `
           <strong>Error:</strong><br>
           ${error.message}<br>
           <small style="color: #a0aec0;">Please connect your wallet to use this feature</small>
         `;
       }
     }

    // Show single user by number
    window.showSingleUser = async function() {
       const userNum = parseInt(document.getElementById('user-index-input').value);
       
       if (!userNum || userNum < 1) {
         showStatus('Please enter a valid number (minimum 1)', 'error');
         return;
       }
       
       const resultDiv = document.getElementById('user-result');
       resultDiv.innerHTML = 'Loading user...';
       resultDiv.style.display = 'block';
       
       try {
         // Use shared wallet connection
         if (!window.connectWallet) {
           throw new Error('Wallet connection not available');
         }
         
         const connection = await window.connectWallet();
         if (!connection || !connection.contract) {
           throw new Error('Contract connection failed');
         }
         
         const { contract, address: currentAddress } = connection;
         
         console.log(`🔄 Fetching user at number ${userNum}...`);
         
         // Get user address by number
         const address = await contract.getAddressByNumber(userNum);
         
         if (!address || address === '0x0000000000000000000000000000000000000000') {
           resultDiv.innerHTML = `
             <strong>User Not Found:</strong><br>
             <small style="color: #a0aec0;">No user found at this number (may not exist yet)</small>
           `;
           return;
         }
         
         console.log(`✅ User found at number ${userNum}: ${address}`);
         
         // Check if current user is in the downline of the target user using contract's isInDownline
         console.log('🔄 Checking if current user is in downline...');
         const isInDownline = await contract.isInDownline(currentAddress, address);
         
         if (!isInDownline && currentAddress.toLowerCase() !== address.toLowerCase()) {
           resultDiv.innerHTML = `
             <div style="color: #ff6b6b; text-align: center; padding: 1rem;">
               ❌ Access Denied<br>
               <strong>This user is not part of your downline</strong><br>
               <small style="color: #a0aec0;">You can only view users who are in your referral network</small>
             </div>
           `;
           return;
         }
         
         console.log('✅ User is in downline, proceeding to show complete user data...');
         
        // Get complete user data from contract
         const userData = await contract.users(address);
         const balance = await contract.balanceOf(address);
         const voteStatus = await contract.getVoteStatus(address);
         
         console.log('📊 Complete user data:', userData);
         
         // Format user data for display
         const formatBigInt = (value) => {
           if (typeof value === 'bigint') {
             return value.toString();
           }
           return value || '0';
         };
         
         const formatTimestamp = (timestamp) => {
           if (!timestamp || timestamp === 0n) return 'Never';
           const date = new Date(Number(timestamp) * 1000);
           return date.toLocaleString();
         };
         
         const formatEther = (value) => {
           if (typeof value === 'bigint') {
             return ethers.formatUnits(value, 18);
           }
           return value || '0';
         };
         
         const formatAddress = (addr) => {
           if (!addr || addr === '0x0000000000000000000000000000000000000000') {
             return { short: 'None', full: 'None', hasValue: false };
           }
           return {
             short: addr.substring(0, 6) + '...' + addr.substring(38),
             full: addr,
             hasValue: true
           };
         };
         
         const parentAddr = formatAddress(userData.parent);
         const leftChildAddr = formatAddress(userData.leftChild);
         const rightChildAddr = formatAddress(userData.rightChild);
         const userAddr = formatAddress(address);
         
         // Calculate unclaimed points
         const unclaimedPoints = userData.binaryPoints > userData.binaryPointsClaimed 
           ? (userData.binaryPoints - userData.binaryPointsClaimed) 
           : 0n;
         
         // Format referral claimed in IAM
        const referralClaimedIAM = formatEther(userData.refclimed || 0n);
        const totalPurchasedIAM = formatEther(userData.totalPurchasedKind || 0n);

        // Count subtree wallets (address-based DFS)
        async function countSubtreeByAddress(rootAddress) {
          try {
            if (!rootAddress || rootAddress === '0x0000000000000000000000000000000000000000') return 0;
            const visited = new Set();
            const stack = [rootAddress];
            let count = 0;
            while (stack.length > 0) {
              const current = stack.pop();
              const key = current.toLowerCase();
              if (visited.has(key)) continue;
              visited.add(key);
              count += 1;
              try {
                const u = await contract.users(current);
                if (u && u.leftChild && u.leftChild !== '0x0000000000000000000000000000000000000000') {
                  stack.push(u.leftChild);
                }
                if (u && u.rightChild && u.rightChild !== '0x0000000000000000000000000000000000000000') {
                  stack.push(u.rightChild);
                }
              } catch (_) {}
            }
            return count;
          } catch (_) { return 0; }
        }

        const leftWalletsCount = leftChildAddr.hasValue ? await countSubtreeByAddress(userData.leftChild) : 0;
        const rightWalletsCount = rightChildAddr.hasValue ? await countSubtreeByAddress(userData.rightChild) : 0;
         
         // Display complete user information with mobile responsive design
         resultDiv.innerHTML = `
           <style>
             .user-info-container {
               display: grid;
               gap: 1rem;
               max-height: 600px;
               overflow-y: auto;
               padding: 0.5rem;
             }
             .user-info-card {
               background: rgba(0, 255, 136, 0.1);
               border: 1px solid rgba(0, 255, 136, 0.2);
               border-radius: 12px;
               padding: 1rem;
               word-wrap: break-word;
             }
             .user-info-card.binary {
               background: rgba(167, 134, 255, 0.1);
               border-color: rgba(167, 134, 255, 0.2);
             }
             .user-info-card.referral {
               background: rgba(255, 193, 7, 0.1);
               border-color: rgba(255, 193, 7, 0.2);
             }
             .user-info-card.voting {
               background: rgba(0, 123, 255, 0.1);
               border-color: rgba(0, 123, 255, 0.2);
             }
             .user-info-card h4 {
               margin: 0 0 0.75rem 0;
               font-size: 1rem;
               font-weight: 600;
               display: flex;
               align-items: center;
               gap: 0.5rem;
             }
             .info-grid {
               display: grid;
               grid-template-columns: 1fr 1fr;
               gap: 0.75rem;
             }
             .info-item {
               font-size: 0.875rem;
               line-height: 1.5;
               word-break: break-word;
             }
             .info-item.full-width {
               grid-column: 1 / -1;
             }
             .info-label {
               color: #a0aec0;
               font-weight: 500;
               margin-bottom: 0.25rem;
               display: block;
               font-size: 0.8rem;
             }
             .info-value {
               color: #e2e8f0;
               font-weight: 600;
               word-break: break-all;
             }
             .address-copy-btn {
               background: rgba(167, 134, 255, 0.2);
               border: 1px solid rgba(167, 134, 255, 0.3);
               color: #a786ff;
               padding: 0.25rem 0.5rem;
               border-radius: 4px;
               cursor: pointer;
               font-size: 0.75rem;
               margin-left: 0.5rem;
               transition: all 0.2s;
             }
             .address-copy-btn:hover {
               background: rgba(167, 134, 255, 0.3);
               transform: scale(1.05);
             }
             .action-buttons {
               display: grid;
               grid-template-columns: 1fr 1fr;
               gap: 0.75rem;
               margin-top: 1rem;
             }
             .action-btn {
               padding: 0.75rem 1rem;
               border: none;
               border-radius: 8px;
               cursor: pointer;
               font-size: 0.875rem;
               font-weight: 600;
               transition: all 0.2s;
               white-space: nowrap;
             }
             .action-btn:hover {
               transform: translateY(-2px);
               box-shadow: 0 4px 8px rgba(0,0,0,0.2);
             }
             .action-btn.copy-address {
               background: #a786ff;
               color: white;
             }
             .action-btn.copy-number {
               background: #00ff88;
               color: #1a202c;
             }
             @media (max-width: 768px) {
               .info-grid {
                 grid-template-columns: 1fr;
                 gap: 0.5rem;
               }
               .info-item {
                 font-size: 0.8rem;
               }
               .user-info-card {
                 padding: 0.75rem;
                 border-radius: 8px;
               }
               .user-info-card h4 {
                 font-size: 0.9rem;
                 margin-bottom: 0.5rem;
               }
               .action-buttons {
                 grid-template-columns: 1fr;
               }
               .action-btn {
                 padding: 0.875rem 1rem;
                 font-size: 0.9rem;
               }
               .user-info-container {
                 max-height: none;
                 padding: 0.25rem;
               }
             }
           </style>
           
           <div style="color: #00ff88; text-align: center; padding: 1rem; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600;">
             ✅ User Information for Number ${userNum}
           </div>
           
           <div class="user-info-container">
             
             <!-- Basic Information -->
             <div class="user-info-card">
               <h4 style="color: #00ff88;">📊 Basic Information</h4>
               <div class="info-grid">
                 <div class="info-item">
                   <span class="info-label">Number (num)</span>
                   <span class="info-value">${formatBigInt(userData.num)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">IAM Balance</span>
                   <span class="info-value">${parseFloat(formatEther(balance)).toFixed(6)} IAM</span>
                 </div>
                 <div class="info-item full-width">
                   <span class="info-label">User Address</span>
                   <span class="info-value">
                     ${userAddr.short}
                     <button class="address-copy-btn" onclick="copyToClipboard('${userAddr.full}')" title="Copy full address">📋</button>
                   </span>
                 </div>
                 <div class="info-item full-width">
                   <span class="info-label">Registration Date</span>
                   <span class="info-value">${formatTimestamp(userData.registrationDate)}</span>
                 </div>
                 <div class="info-item full-width">
                   <span class="info-label">Parent Address</span>
                   <span class="info-value">
                     ${parentAddr.short}
                     ${parentAddr.hasValue ? `<button class="address-copy-btn" onclick="copyToClipboard('${parentAddr.full}')" title="Copy full address">📋</button>` : ''}
                   </span>
                 </div>
                 <div class="info-item full-width">
                   <span class="info-label">Left Child Address</span>
                   <span class="info-value">
                     ${leftChildAddr.short}
                     ${leftChildAddr.hasValue ? `<button class="address-copy-btn" onclick="copyToClipboard('${leftChildAddr.full}')" title="Copy full address">📋</button>` : ''}
                   </span>
                 </div>
                 <div class="info-item full-width">
                   <span class="info-label">Right Child Address</span>
                   <span class="info-value">
                     ${rightChildAddr.short}
                     ${rightChildAddr.hasValue ? `<button class="address-copy-btn" onclick="copyToClipboard('${rightChildAddr.full}')" title="Copy full address">📋</button>` : ''}
                   </span>
                 </div>
               </div>
             </div>
             
             <!-- Binary Points -->
             <div class="user-info-card binary">
               <h4 style="color: #a786ff;">⭐ Binary Points</h4>
               <div class="info-grid">
                 <div class="info-item">
                   <span class="info-label">Total Points</span>
                   <span class="info-value">${formatBigInt(userData.binaryPoints)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Point Cap</span>
                   <span class="info-value">${formatBigInt(userData.binaryPointCap)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Points Claimed</span>
                   <span class="info-value">${formatBigInt(userData.binaryPointsClaimed)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Unclaimed Points</span>
                   <span class="info-value">${formatBigInt(unclaimedPoints)}</span>
                 </div>
               </div>
             </div>
             
             <!-- Referral System -->
             <div class="user-info-card referral">
               <h4 style="color: #ffc107;">🌳 Referral System</h4>
               <div class="info-grid">
                 <div class="info-item">
                   <span class="info-label">Left Points</span>
                   <span class="info-value">${formatBigInt(userData.leftPoints)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Right Points</span>
                   <span class="info-value">${formatBigInt(userData.rightPoints)}</span>
                 </div>
                <div class="info-item">
                  <span class="info-label">Left Wallets Count</span>
                  <span class="info-value">${leftWalletsCount}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Right Wallets Count</span>
                  <span class="info-value">${rightWalletsCount}</span>
                </div>
                 <div class="info-item full-width">
                   <span class="info-label">Total Purchased (IAM)</span>
                   <span class="info-value">${parseFloat(totalPurchasedIAM).toFixed(6)} IAM</span>
                 </div>
                 <div class="info-item full-width">
                   <span class="info-label">Referral Claimed (IAM)</span>
                   <span class="info-value">${parseFloat(referralClaimedIAM).toFixed(6)} IAM</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Upgrade Time</span>
                   <span class="info-value" style="font-size: 0.75rem;">${formatTimestamp(userData.upgradeTime)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Last Claim Time</span>
                   <span class="info-value" style="font-size: 0.75rem;">${formatTimestamp(userData.lastClaimTime)}</span>
                 </div>
               </div>
             </div>
             
             <!-- Voting Status -->
             <div class="user-info-card voting">
               <h4 style="color: #007bff;">🗳️ Voting Status</h4>
               <div class="info-grid">
                 <div class="info-item">
                   <span class="info-label">Total Likes</span>
                   <span class="info-value">${formatBigInt(voteStatus[0] || 0)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Total Dislikes</span>
                   <span class="info-value">${formatBigInt(voteStatus[1] || 0)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Net Score</span>
                   <span class="info-value">${Number(voteStatus[0] || 0) - Number(voteStatus[1] || 0)}</span>
                 </div>
                 <div class="info-item">
                   <span class="info-label">Your Vote</span>
                   <span class="info-value">${voteStatus[2] === 1 ? '👍 Liked' : voteStatus[2] === 2 ? '👎 Disliked' : '❌ No Vote'}</span>
                 </div>
               </div>
             </div>
             
             <!-- Action Buttons -->
             <div class="action-buttons">
               <button class="action-btn copy-address" onclick="copyToClipboard('${address}')">
                 📋 Copy Address
               </button>
               <button class="action-btn copy-number" onclick="copyToClipboard('${userNum}')">
                 🔢 Copy Number
               </button>
             </div>
             
           </div>
         `;
       } catch (error) {
         console.error('Error fetching user:', error);
         resultDiv.innerHTML = `
           <strong>Error:</strong><br>
           ${error.message}<br>
           <small style="color: #a0aec0;">To use this feature, please connect your wallet</small>
         `;
       }
     }

    // Copy to clipboard
    window.copyToClipboard = function(text) {
       navigator.clipboard.writeText(text).then(() => {
         alert('Copied!');
       }).catch(() => {
         // Fallback for older browsers
         const textArea = document.createElement('textarea');
         textArea.value = text;
         document.body.appendChild(textArea);
         textArea.select();
         document.execCommand('copy');
         document.body.removeChild(textArea);
         alert('Copied!');
       });
     }

    // Update status time
    window.updateStatusTime = function() {
       const now = new Date();
       const timeString = now.toLocaleString('en-US');
       const statusTimeElement = document.getElementById('status-time');
       if (statusTimeElement) {
         statusTimeElement.textContent = timeString;
       }
     }


    // Vote for user by number
    window.voteForIndex = async function(isLike) {
       const input = document.getElementById('vote-index-input');
       const res = document.getElementById('vote-result');
       if (!input || !res) return;
       
       const num = parseInt(input.value);
       if (!num || num < 1) {
         res.style.display = 'block';
         res.style.background = 'rgba(255,68,68,0.1)';
         res.style.borderColor = 'rgba(255,68,68,0.2)';
         res.textContent = '⚠️ Please enter a valid number';
         return;
       }
       
       try {
         res.style.display = 'block';
         res.style.background = 'rgba(167,134,255,0.1)';
         res.style.borderColor = 'rgba(167,134,255,0.2)';
         res.textContent = '⏳ Sending vote...';
         
         const connection = await window.connectWallet();
         if (!connection || !connection.contract) {
           throw new Error('Contract connection failed');
         }
         
         const { contract, address: currentAddress } = connection;
         // Use getAddressByNumber instead of indexToAddress
         const address = await contract.getAddressByNumber(num);
         
         if (!address || address === '0x0000000000000000000000000000000000000000') {
           throw new Error('No user found at this number');
         }
         
         // Check if user is trying to vote for themselves
         if (currentAddress && currentAddress.toLowerCase() === address.toLowerCase()) {
           res.style.background = 'rgba(255,68,68,0.1)';
           res.style.borderColor = 'rgba(255,68,68,0.2)';
           res.textContent = '❌ Cannot vote for yourself';
           return;
         }
         
         const tx = await contract.voteUser(address, isLike);
         await tx.wait();
         
         res.style.background = 'rgba(0,255,136,0.1)';
         res.style.borderColor = 'rgba(0,255,136,0.2)';
         res.textContent = isLike ? '✅ Like registered' : '✅ Dislike registered';
       } catch (e) {
         res.style.display = 'block';
         res.style.background = 'rgba(255,68,68,0.1)';
         res.style.borderColor = 'rgba(255,68,68,0.2)';
         res.textContent = '❌ Error: ' + (e?.message || 'Voting error');
       }
     }

     // Card animations
     document.addEventListener('DOMContentLoaded', async function() {
       const cards = document.querySelectorAll('.utility-card');
       cards.forEach((card, index) => {
         card.style.opacity = '0';
         card.style.transform = 'translateY(20px)';
         setTimeout(() => {
           card.style.transition = 'all 0.5s ease';
           card.style.opacity = '1';
           card.style.transform = 'translateY(0)';
         }, index * 100);
       });
       
       // Contract is set to new contract by default
       console.log('✅ Using contract:', window.IAM_ADDRESS);
       
       updateStatusTime();
       setInterval(updateStatusTime, 60000); // Update every minute
       
       // Auto-connect wallet on page load (silent)
       try {
         if (window.connectWallet) {
           const connection = await window.connectWallet();
           if (connection && connection.address) {
             console.log('✅ Wallet auto-connected:', connection.address);
           } else {
             console.log('⚠️ Wallet not connected');
           }
         } else {
           console.log('⚠️ Wallet connection not available');
         }
       } catch (error) {
         console.log('⚠️ Auto-connect failed:', error.message);
       }
     
       // Initialize IAM ↔ DAI converter
       try {
         setupIamDaiConverter();
         console.log('✅ IAM ↔ DAI converter initialized');
       } catch (e) {
         console.warn('⚠️ Failed to initialize IAM ↔ DAI converter:', e);
       }
     });
   
  </script>
  
  
  <script>

    // ===== IAM ↔ DAI Converter (on-chain) =====
    function debounce(fn, ms){ let t; return function(){ clearTimeout(t); const a=arguments; t=setTimeout(()=>fn.apply(this,a), ms); } }

    async function getReadonlyContract() {
      try {
        if (window.contractConfig && window.contractConfig.contract) return window.contractConfig.contract;
        if (typeof window.ethereum !== 'undefined') {
          const provider = new ethers.BrowserProvider(window.ethereum, 'any');
          const net = await provider.getNetwork().catch(()=>null);
          const runner = provider; // runner is enough for read-only
          if (window.IAM_ADDRESS && window.IAM_ABI) {
            return new ethers.Contract(window.IAM_ADDRESS, window.IAM_ABI, runner);
          }
        }
        // Fallback: public RPC (readonly). Replace with your network RPC if needed.
        const rpc = (window.RPC_URL) ? window.RPC_URL : 'https://polygon-rpc.com';
        const provider = new ethers.JsonRpcProvider(rpc);
        return new ethers.Contract(window.IAM_ADDRESS, window.IAM_ABI, provider);
      } catch (_) {
        throw new Error('No provider available');
      }
    }

    async function ensureContract() {
      // Prefer connected contract; otherwise use readonly
      try { return await getReadonlyContract(); } catch (e) { throw e; }
    }

    async function estimateDaiFromIamAmount(iamStr){
      const contract = await ensureContract();
      let iamWei;
      try { iamWei = ethers.parseUnits(String(iamStr||'0').trim() || '0', 18); } catch { iamWei = 0n; }
      if (iamWei <= 0n) return '0';
      try {
        if (typeof contract.estimateSell === 'function') {
          const daiWei = await contract.estimateSell(iamWei);
          return ethers.formatUnits(daiWei, 18);
        }
      } catch (_) {}
      try {
        const priceWei = await contract.getTokenPrice();
        const daiWei = (iamWei * priceWei) / 10n**18n;
        return ethers.formatUnits(daiWei, 18);
      } catch (e) {
        throw new Error('Price fetch failed');
      }
    }

    async function estimateIamFromDaiAmount(daiStr){
      const contract = await ensureContract();
      let daiWei;
      try { daiWei = ethers.parseUnits(String(daiStr||'0').trim() || '0', 18); } catch { daiWei = 0n; }
      if (daiWei <= 0n) return '0';
      try {
        if (typeof contract.estimateBuy === 'function') {
          const iamWei = await contract.estimateBuy(daiWei);
          return ethers.formatUnits(iamWei, 18);
        }
      } catch (_) {}
      try {
        const priceWei = await contract.getTokenPrice();
        const iamWei = (daiWei * 10n**18n) / priceWei;
        return ethers.formatUnits(iamWei, 18);
      } catch (e) {
        throw new Error('Price fetch failed');
      }
    }

    function setupIamDaiConverter(){
      const iamInput = document.getElementById('conv-iam');
      const daiInput = document.getElementById('conv-dai');
      const result = document.getElementById('conv-result');
      const btnMaxIam = document.getElementById('conv-iam-max');
      const btnMaxDai = document.getElementById('conv-dai-max');
      const btnIamToDai = document.getElementById('btn-iam-to-dai');
      const btnDaiToIam = document.getElementById('btn-dai-to-iam');
      if (!iamInput || !daiInput || !result) return;

      const setResult = (msg, ok=true)=>{
        result.style.display = msg ? 'block' : 'none';
        result.style.background = ok ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,68,0.1)';
        result.style.borderColor = ok ? 'rgba(0,255,136,0.2)' : 'rgba(255,68,68,0.2)';
        result.textContent = msg;
      };

      const setResultLines = (inLabel, inValue, outLabel, outValue, ok=true) => {
        const hasContent = (inValue !== '' && outValue !== '');
        result.style.display = hasContent ? 'block' : 'none';
        result.style.background = ok ? 'rgba(0,255,136,0.1)' : 'rgba(255,68,68,0.1)';
        result.style.borderColor = ok ? 'rgba(0,255,136,0.2)' : 'rgba(255,68,68,0.2)';
        result.innerHTML = hasContent ? `<div>${inLabel}: ${inValue}</div><div>${outLabel}: ${outValue}</div>` : '';
      };

      const onIamChange = debounce(async ()=>{
        const v = iamInput.value.trim();
        if (!v){ setResult(''); return; }
        try {
          const out = await estimateDaiFromIamAmount(v);
          if (document.activeElement !== daiInput) daiInput.value = out;
          setResultLines('IAM', v, 'DAI', out, true);
        } catch(e){ setResult(e.message||'Conversion error', false); }
      }, 250);

      const onDaiChange = debounce(async ()=>{
        const v = daiInput.value.trim();
        if (!v){ setResult(''); return; }
        try {
          const out = await estimateIamFromDaiAmount(v);
          if (document.activeElement !== iamInput) iamInput.value = out;
          setResultLines('DAI', v, 'IAM', out, true);
        } catch(e){ setResult(e.message||'Conversion error', false); }
      }, 250);

      iamInput.addEventListener('input', onIamChange);
      daiInput.addEventListener('input', onDaiChange);

      // Fetch wallet balances and set Max
      async function fetchBalances() {
        try {
          if (!window.connectWallet) return { iam: null, dai: null };
          const { contract, provider, address } = await window.connectWallet();
          let iamBal = null, daiBal = null;
          try {
            if (contract && typeof contract.balanceOf === 'function') {
              const b = await contract.balanceOf(address);
              iamBal = Number(ethers.formatUnits(b, 18));
            }
          } catch(_) {}
          try {
            const daiAddr = window.DAI_ADDRESS || (window.contractConfig && window.contractConfig.DAI_ADDRESS);
            if (provider && daiAddr) {
              const minimalDaiAbi = [{"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}];
              const Dai = new ethers.Contract(daiAddr, minimalDaiAbi, provider);
              const d = await Dai.balanceOf(address);
              daiBal = Number(ethers.formatUnits(d, 18));
            }
          } catch(_) {}
          return { iam: iamBal, dai: daiBal };
        } catch { return { iam: null, dai: null }; }
      }

      async function setMaxIam() {
        const { iam } = await fetchBalances();
        if (iam === null || isNaN(iam)) return;
        iamInput.value = iam.toString();
        iamInput.dispatchEvent(new Event('input', { bubbles: true }));
      }

      async function setMaxDai() {
        const { dai } = await fetchBalances();
        if (dai === null || isNaN(dai)) return;
        daiInput.value = dai.toString();
        daiInput.dispatchEvent(new Event('input', { bubbles: true }));
      }

      if (btnMaxIam) btnMaxIam.addEventListener('click', setMaxIam);
      if (btnMaxDai) btnMaxDai.addEventListener('click', setMaxDai);

      if (btnIamToDai) btnIamToDai.onclick = async ()=>{
        const v = iamInput.value.trim();
        if (!v){ setResult(''); return; }
        try { const out = await estimateDaiFromIamAmount(v); daiInput.value = out; setResultLines('IAM', v, 'DAI', out, true); }
        catch(e){ setResult(e.message||'Conversion error', false); }
      };
      if (btnDaiToIam) btnDaiToIam.onclick = async ()=>{
        const v = daiInput.value.trim();
        if (!v){ setResult(''); return; }
        try { const out = await estimateIamFromDaiAmount(v); iamInput.value = out; setResultLines('DAI', v, 'IAM', out, true); }
        catch(e){ setResult(e.message||'Conversion error', false); }
      };
    }

    // Voting helpers for utility page
    window.voteFromAddressCard = async function(isLike){
      const input = document.getElementById('vote-address-input');
      const res = document.getElementById('vote-address-result');
      if (!input || !res) return;
      const address = (input.value||'').trim();
      if (!address || !address.startsWith('0x') || address.length < 42){
        res.style.display='block';
        res.style.background='rgba(255,68,68,0.1)';
        res.style.borderColor='rgba(255,68,68,0.2)';
        res.textContent='⚠️ Please enter a valid address';
        return;
      }
      try{
        res.style.display='block';
        res.style.background='rgba(167,134,255,0.1)';
        res.style.borderColor='rgba(167,134,255,0.2)';
        res.textContent='⏳ Sending vote...';
        
        const connection = await window.connectWallet();
        if (!connection || !connection.contract) {
          throw new Error('Contract connection failed');
        }
        
        const { address: currentAddress } = connection;
        
        // Check if user is trying to vote for themselves
        if (currentAddress && currentAddress.toLowerCase() === address.toLowerCase()) {
          res.style.background = 'rgba(255,68,68,0.1)';
          res.style.borderColor = 'rgba(255,68,68,0.2)';
          res.textContent = '❌ Cannot vote for yourself';
          return;
        }
        
        const tx = await connection.contract.voteUser(address, isLike);
        await tx.wait();
        
        res.style.background='rgba(0,255,136,0.1)';
        res.style.borderColor='rgba(0,255,136,0.2)';
        res.textContent = isLike ? '✅ Like registered' : '✅ Dislike registered';
      }catch(e){
        res.style.display='block';
        res.style.background='rgba(255,68,68,0.1)';
        res.style.borderColor='rgba(255,68,68,0.2)';
        res.textContent='❌ Error: ' + (e?.message||'Voting error');
      }
    }

    window.showVoteStatus = async function(){
      const input = document.getElementById('vote-status-input');
      const res = document.getElementById('vote-status-result');
      if (!input || !res) return;
      const raw = (input.value||'').trim();
      if (!raw){ res.style.display='none'; return; }
      try{
        const connection = await window.connectWallet();
        if (!connection || !connection.contract) {
          throw new Error('Contract connection failed');
        }
        const contract = connection.contract;
        // Determine if raw is number or address
        let address = raw;
        if (!raw.startsWith('0x')){
          const num = parseInt(raw, 10);
          if (!num || num <= 0) throw new Error('Invalid number');
          // Use getAddressByNumber instead of indexToAddress
          address = await contract.getAddressByNumber(num);
        }
        if (!address || address === '0x0000000000000000000000000000000000000000'){
          throw new Error('No user found for this input');
        }
        const vs = await contract.getVoteStatus(address);
        const totalLikes = (vs[0] ?? 0).toString();
        const totalDislikes = (vs[1] ?? 0).toString();
        const myVote = Number(vs[2] ?? 0);
        const myVoteText = myVote === 1 ? 'Liked' : myVote === 2 ? 'Disliked' : 'No vote';
        const net = (Number(totalLikes) - Number(totalDislikes)).toString();
        res.style.display='block';
        res.style.background='rgba(0,255,136,0.1)';
        res.style.borderColor='rgba(0,255,136,0.2)';
        res.innerHTML = `<div>Address: ${address}</div><div>Likes: ${totalLikes} | Dislikes: ${totalDislikes}</div><div>Your vote: ${myVoteText}</div><div>Net score: ${net}</div>`;
      }catch(e){
        res.style.display='block';
        res.style.background='rgba(255,68,68,0.1)';
        res.style.borderColor='rgba(255,68,68,0.2)';
        res.textContent='❌ Error: ' + (e?.message||'Status error');
      }
    }
  </script>
  
</body>
</html>
